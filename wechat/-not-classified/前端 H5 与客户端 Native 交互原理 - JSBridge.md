> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/h6vlkf5rgyI9GpEpPxO9cg)

![](https://mmbiz.qpic.cn/mmbiz_png/xdDaByDutCjAmyLtEqTAMsib5OJh6S6mPiadQyCOHNzUdyYbWTfk32WkUfq4DV9FJsfiatfYcicXiaL0Dwm8UdSDemw/640?wx_fmt=png)

**æ¦‚è¿°**  

åœ¨æ··åˆåº”ç”¨å¼€å‘ä¸­ï¼Œä¸€ç§å¸¸è§ä¸”æˆç†Ÿçš„æŠ€æœ¯æ–¹æ¡ˆæ˜¯å°†åŸç”Ÿåº”ç”¨ä¸ WebView ç»“åˆï¼Œä½¿å¾—å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¯ä»¥é€šè¿‡ç½‘é¡µæŠ€æœ¯å®ç°ã€‚å®ç°è¿™ç§ç±»å‹çš„æ··åˆåº”ç”¨æ—¶ï¼Œå°±éœ€è¦è§£å†³ H5 ä¸ Native ä¹‹é—´çš„åŒå‘é€šä¿¡ã€‚JSBridge æ˜¯ä¸€ç§åœ¨æ··åˆåº”ç”¨ä¸­å®ç° Web å’ŒåŸç”Ÿä»£ç ä¹‹é—´é€šä¿¡çš„é‡è¦æœºåˆ¶ã€‚

**æ··åˆå¼€å‘**

æ··åˆå¼€å‘ï¼ˆHybridï¼‰æ˜¯ä¸€ç§å¼€å‘æ¨¡å¼ï¼ŒæŒ‡ä½¿ç”¨å¤šç§å¼€å‘æ¨¡å‹å¼€å‘ Appï¼Œé€šå¸¸ä¼šæ¶‰åŠåˆ°ä¸¤å¤§ç±»æŠ€æœ¯ï¼šåŸç”Ÿ Nativeã€Web H5ã€‚

*   åŸç”ŸæŠ€æœ¯ä¸»è¦æŒ‡ iOSã€Androidï¼ŒåŸç”Ÿå¼€å‘æ•ˆç‡è¾ƒä½ï¼Œå¼€å‘å®Œæˆéœ€è¦é‡æ–°æ‰“åŒ…æ•´ä¸ª Appï¼Œå‘å¸ƒä¾èµ–ç”¨æˆ·çš„æ›´æ–°ï¼Œæ€§èƒ½è¾ƒé«˜åŠŸèƒ½è¦†ç›–ç‡æ›´é«˜
    
*   Web H5 å¯ä»¥æ›´å¥½çš„å®ç°å‘å¸ƒæ›´æ–°ï¼Œè·¨å¹³å°ä¹Ÿæ›´åŠ ä¼˜ç§€ï¼Œä½†æ€§èƒ½è¾ƒä½ï¼Œç‰¹æ€§ä¹Ÿå—é™
    

æ··åˆå¼€å‘çš„æ„ä¹‰å°±åœ¨äºå¸å–ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œè€Œä¸”éšç€æ‰‹æœºç¡¬ä»¶çš„å‡çº§è¿­ä»£ã€ç³»ç»Ÿï¼ˆAndroid 5.0+ã€ISO 9.0+ï¼‰å¯¹äº Web ç‰¹æ€§çš„è¾ƒå¥½æ”¯æŒï¼ŒH5 çš„åŠ£åŠ¿è¢«é€æ¸ç¼©å°ã€‚

**JSBridge çš„æ¦‚å¿µå’Œä½œç”¨**  

*   é€šä¿¡æ¡¥æ¢ï¼šJSBridge å……å½“äº† Web åº”ç”¨å’ŒåŸç”Ÿåº”ç”¨ä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ã€‚é€šè¿‡ JSBridgeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ web å’ŒåŸç”Ÿä»£ç ä¹‹é—´è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œä½¿è¿™ä¸¤è€…èƒ½å¤Ÿäº’ç›¸è°ƒç”¨å’Œä¼ é€’æ•°æ®ã€‚
    
*   åŸç”ŸåŠŸèƒ½è°ƒç”¨ï¼šä½¿ç”¨ JSBridgeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ JavaScript ä¸­è°ƒç”¨åŸç”Ÿåº”ç”¨ä¸­çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ web æ¥è§¦å‘åŸç”Ÿåº”ç”¨ä¸­çš„ç‰¹å®šæ“ä½œï¼Œå¦‚æ‰“å¼€ç›¸æœºã€å‘é€é€šçŸ¥ã€è°ƒç”¨ç¡¬ä»¶è®¾å¤‡ç­‰ã€‚
    
*   æ•°æ®ä¼ é€’ï¼šJSBridge ä½¿å¾— JavaScript å’ŒåŸç”Ÿä»£ç ä¹‹é—´å¯ä»¥æ–¹ä¾¿åœ°ä¼ é€’æ•°æ®ã€‚æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨ web å’ŒåŸç”Ÿä»£ç ä¹‹é—´ä¼ é€’å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¦‚å¯¹è±¡ã€æ•°ç»„ç­‰ï¼Œä»¥æ»¡è¶³åº”ç”¨çš„åŠŸèƒ½éœ€æ±‚ã€‚
    
*   å›è°ƒæœºåˆ¶ï¼šJSBridge æ”¯æŒå›è°ƒæœºåˆ¶ï¼Œä½¿å¾—åœ¨åŸç”Ÿä»£ç æ‰§è¡Œå®ŒæŸäº›æ“ä½œåå¯ä»¥é€šçŸ¥ JavaScriptï¼Œå¹¶ä¼ é€’ç›¸åº”çš„ç»“æœã€‚
    

**ä¸ºä»€ä¹ˆåœ¨æ··åˆåº”ç”¨å¼€å‘ä¸­ JSBridge å¦‚æ­¤é‡è¦**  

*   è·¨å¹³å°å¼€å‘ï¼šJSBridge å…è®¸æˆ‘ä»¬åœ¨æ··åˆåº”ç”¨ä¸­ä½¿ç”¨ä¸€å¥—ä»£ç åŒæ—¶è¿è¡Œåœ¨ä¸åŒçš„å¹³å°ä¸Šã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Web æŠ€æœ¯æ¥å¼€å‘åº”ç”¨çš„æ ¸å¿ƒé€»è¾‘ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šè¿‡ JSBridge è°ƒç”¨åŸç”ŸåŠŸèƒ½ï¼Œä»è€Œå®ç°è·¨å¹³å°å¼€å‘ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
    
*   åŸç”ŸåŠŸèƒ½æ‰©å±•ï¼šä½¿ç”¨ JSBridgeï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨åŸç”Ÿå¹³å°æä¾›çš„åŠŸèƒ½å’Œèƒ½åŠ›ï¼Œä¾‹å¦‚è®¿é—®ç¡¬ä»¶è®¾å¤‡ã€è°ƒç”¨ç³»ç»Ÿ API ç­‰ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨æ·»åŠ æ›´å¤šä¸°å¯Œçš„åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
    
*   çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼šJSBridge æä¾›äº†ä¸€ç§çµæ´»å’Œå¯æ‰©å±•çš„æ–¹å¼æ¥å®ç° Web å’ŒåŸç”Ÿä»£ç ä¹‹é—´çš„é€šä¿¡ã€‚å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€æ±‚éšæ—¶æ·»åŠ æ–°çš„åŸç”ŸåŠŸèƒ½ï¼Œå¹¶é€šè¿‡ JSBridge åœ¨ JavaScript ä¸­è°ƒç”¨è¿™äº›åŠŸèƒ½ï¼Œä»è€Œå®ç°åº”ç”¨çš„åŠŸèƒ½æ‰©å±•å’Œå‡çº§ã€‚Â 
    

**JSBridge åšäº†ä»€ä¹ˆ**  

åœ¨ Hybrid æ¨¡å¼ä¸‹ï¼ŒH5 ä¼šéœ€è¦ä½¿ç”¨ Native çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ‰“å¼€äºŒç»´ç æ‰«æã€è°ƒç”¨åŸç”Ÿé¡µé¢ã€è·å–ç”¨æˆ·ä¿¡æ¯ç­‰ï¼ŒåŒæ—¶ Native ä¹Ÿéœ€è¦å‘ Web ç«¯å‘é€æ¨é€ã€æ›´æ–°çŠ¶æ€ç­‰ï¼Œè€Œ JavaScript æ˜¯è¿è¡Œåœ¨å•ç‹¬çš„ JS Context ä¸­ï¼ˆWebview å®¹å™¨ï¼‰ä¸åŸç”Ÿæœ‰è¿è¡Œç¯å¢ƒçš„éš”ç¦»ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ç§æœºåˆ¶å®ç° Native ç«¯å’Œ Web ç«¯çš„ åŒå‘é€šä¿¡ ï¼Œè¿™å°±æ˜¯ JSBridgeï¼šä»¥ JavaScript å¼•æ“æˆ– Webview å®¹å™¨ä½œä¸ºåª’ä»‹ï¼Œé€šè¿‡åå®šåè®®è¿›è¡Œé€šä¿¡ï¼Œå®ç° Native ç«¯å’Œ Web ç«¯åŒå‘é€šä¿¡çš„ä¸€ç§æœºåˆ¶ã€‚

é€šè¿‡ JSBridgeï¼ŒWeb ç«¯å¯ä»¥è°ƒç”¨ Native ç«¯çš„ Java æ¥å£ï¼ŒåŒæ · Native ç«¯ä¹Ÿå¯ä»¥é€šè¿‡ JSBridge è°ƒç”¨ Web ç«¯çš„ JavaScript æ¥å£ï¼Œå®ç°å½¼æ­¤çš„åŒå‘è°ƒç”¨ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/xdDaByDutCiad0Pn0LzbSL7dUTjDZ0l1UCz68B2WNKTKia630TWym6apDghr3hePjBzMaEsdI5cOPYhvXVQx84vw/640?wx_fmt=png&from=appmsg)

**J****SBridge å®ç°åŸç†**

æŠŠ Web ç«¯å’Œ Native ç«¯çš„é€šä¿¡æ¯”ä½œ Client/Server æ¨¡å¼ã€‚JSBridge å……å½“äº†ç±»ä¼¼äº HTTP åè®®çš„è§’è‰²ï¼Œå®ç°äº† Web ç«¯å’Œ Native ç«¯ä¹‹é—´çš„é€šä¿¡ã€‚

å°† Native ç«¯åŸç”Ÿæ¥å£å°è£…æˆ JavaScript æ¥å£ï¼šåœ¨ Native ç«¯å°†éœ€è¦è¢«è°ƒç”¨çš„åŸç”ŸåŠŸèƒ½å°è£…æˆ JavaScript æ¥å£ï¼Œè®© JavaScript ä»£ç å¯ä»¥è°ƒç”¨ã€‚JavaScript æ¥å£ä¼šè¢«æ³¨å†Œåˆ°å…¨å±€å¯¹è±¡ä¸­ï¼Œä»¥ä¾› JavaScript ä»£ç è°ƒç”¨ã€‚

å°† Web ç«¯ JavaScript æ¥å£å°è£…æˆåŸç”Ÿæ¥å£ï¼šè¿™ä¸€æ­¥æ˜¯åœ¨ Web ç«¯å°†éœ€è¦è¢«è°ƒç”¨çš„ JavaScript åŠŸèƒ½å°è£…æˆåŸç”Ÿæ¥å£ã€‚è¿™äº›åŸç”Ÿæ¥å£ä¼šé€šè¿‡ WebView çš„æŸäº›æœºåˆ¶æš´éœ²ç»™åŸç”Ÿä»£ç ï¼Œä»¥ä¾›åŸç”Ÿä»£ç è°ƒç”¨ã€‚

**Native -> Web**  

Native ç«¯è°ƒç”¨ Web ç«¯ï¼ŒJavaScript ä½œä¸ºè§£é‡Šæ€§è¯­è¨€ï¼Œæœ€å¤§çš„ä¸€ä¸ªç‰¹æ€§å°±æ˜¯å¯ä»¥éšæ—¶éšåœ°åœ°é€šè¿‡è§£é‡Šå™¨æ‰§è¡Œä¸€æ®µ JS ä»£ç ï¼Œæ‰€ä»¥å¯ä»¥å°†æ‹¼æ¥çš„ JavaScript ä»£ç å­—ç¬¦ä¸²ï¼Œä¼ å…¥ JS è§£æå™¨æ‰§è¡Œå°±å¯ä»¥ï¼ŒJS è§£æå™¨åœ¨è¿™é‡Œå°±æ˜¯ webViewã€‚

**1. Android**

Android æä¾›äº† evaluateJavascript æ¥æ‰§è¡Œ JS ä»£ç ï¼Œå¹¶ä¸”å¯ä»¥è·å–è¿”å›å€¼æ‰§è¡Œå›è°ƒï¼š

```
String jsCode = String.format("window.showWebDialog('%s')", text);
webView.evaluateJavascript(jsCode, new ValueCallback<String>() {
  @Override
  public void onReceiveValue(String value) {

  }
});
```

**2. IOS**

IOS çš„ WKWebView ä½¿ç”¨ evaluateJavaScriptï¼š

```
[webView evaluateJavaScript:@"æ‰§è¡Œçš„JSä»£ç " 
  completionHandler:^(id _Nullable response, NSError * _Nullable error) {
  // 
}];
```

**Web -> Native**  

Web è°ƒç”¨ Native ç«¯ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

**1. URL Schema**

URL Schema æ˜¯ç±» URL çš„ä¸€ç§è¯·æ±‚æ ¼å¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
<protocol>://<host>/<path>?<qeury>#fragment
  
// æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰JSBridgeé€šä¿¡çš„URL Schemaï¼Œæ¯”å¦‚ï¼š
hellobike://showToast?text=hello
```

Native åŠ è½½ WebView ä¹‹åï¼ŒWeb å‘é€çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šç»è¿‡ WebView ç»„ä»¶ï¼Œæ‰€ä»¥ Native å¯ä»¥é‡å†™ WebView é‡Œçš„æ–¹æ³•ï¼Œä»æ¥æ‹¦æˆª Web å‘èµ·çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯¹è¯·æ±‚çš„æ ¼å¼è¿›è¡Œåˆ¤æ–­ï¼š

*   ç¬¦åˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ URL Schemaï¼Œå¯¹ URL è¿›è¡Œè§£æï¼Œæ‹¿åˆ°ç›¸å…³æ“ä½œã€æ“ä½œï¼Œè¿›è€Œè°ƒç”¨åŸç”Ÿ Native çš„æ–¹æ³•
    
*   ä¸ç¬¦åˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ URL Schemaï¼Œæˆ‘ä»¬ç›´æ¥è½¬å‘ï¼Œè¯·æ±‚çœŸæ­£çš„æœåŠ¡
    

ä¾‹å¦‚ï¼š

```
get existOrderRedirect() {
    let url: string;
    if (this.env.isHelloBikeApp) {
      url = 'hellobike://hellobike.com/xxxxx_xxx?from_type=xxxx&selected_tab=xxxxx';
    } else if (this.env.isSFCApp) {
      url = 'hellohitch://hellohitch.com/xxx/xxxx?bottomTab=xxxx';
    }
    return url;
  }
```

è¿™ç§æ–¹å¼ä»æ—©æœŸå°±å­˜åœ¨ï¼Œå…¼å®¹æ€§å¾ˆå¥½ï¼Œä½†æ˜¯ç”±äºæ˜¯åŸºäº URL çš„æ–¹å¼ï¼Œé•¿åº¦å—åˆ°é™åˆ¶è€Œä¸”ä¸å¤ªç›´è§‚ï¼Œæ•°æ®æ ¼å¼æœ‰é™åˆ¶ï¼Œè€Œä¸”å»ºç«‹è¯·æ±‚æœ‰æ—¶é—´è€—æ—¶ã€‚

**2. åœ¨ Webview ä¸­æ³¨å…¥ JS API**

é€šè¿‡ webView æä¾›çš„æ¥å£ï¼ŒApp å°† Native çš„ç›¸å…³æ¥å£æ³¨å…¥åˆ° JS çš„ Contextï¼ˆwindowï¼‰çš„å¯¹è±¡ä¸­

Web ç«¯å°±å¯ä»¥ç›´æ¥åœ¨å…¨å±€ window ä¸‹ä½¿ç”¨è¿™ä¸ªæš´éœ²çš„å…¨å±€ JS å¯¹è±¡ï¼Œè¿›è€Œè°ƒç”¨åŸç”Ÿç«¯çš„æ–¹æ³•ã€‚

Android æ³¨å…¥æ–¹æ³•ï¼š

*   4.2 å‰ï¼ŒAndroid æ³¨å…¥ JavaScript å¯¹è±¡çš„æ¥å£æ˜¯ addJavascriptInterface ä½†æ˜¯è¿™ä¸ªæ¥å£æœ‰æ¼æ´
    
*   4.2 ä¹‹åï¼ŒAndroid å¼•å…¥æ–°çš„æ¥å£ @JavascriptInterface ä»¥è§£å†³å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥ Android æ³¨å…¥å¯¹å¯¹è±¡çš„æ–¹å¼æ˜¯æœ‰å…¼å®¹æ€§é—®é¢˜çš„ã€‚
    

IOS æ³¨å…¥æ–¹æ³•ï¼š

*   iOS çš„ UIWebViewï¼šJavaSciptCore æ”¯æŒ iOS 7.0 åŠä»¥ä¸Šç³»ç»Ÿ
    
*   iOS çš„ WKWebViewï¼šWKScriptMessageHandler æ”¯æŒ iOS 8.0 åŠä»¥ä¸Šç³»ç»Ÿ
    

ä¾‹å¦‚ï¼š

*   æ³¨å…¥å…¨å±€å¯¹è±¡
    

```
// æ³¨å…¥å…¨å±€JSå¯¹è±¡
webView.addJavascriptInterface(new NativeBridge(this), "NativeBridge");

class NativeBridge {
    private Context ctx;
    NativeBridge(Context ctx) {
        this.ctx = ctx;
    }

    // ç»‘å®šæ–¹æ³•
    @JavascriptInterface
    public void showNativeDialog(String text) {
        new AlertDialog.Builder(ctx).setMessage(text).create().show();
    }
}
```

*   Web è°ƒç”¨æ–¹æ³•ï¼š
    

```
// è°ƒç”¨nativeBridgeçš„æ–¹æ³•
window.NativeBridge.showNativeDialog('hello');
```

**H5 å…·ä½“å®ç°**  

å°†åŠŸèƒ½æŠ½è±¡ä¸ºä¸€ä¸ª AppBridge ç±»ï¼Œå°è£…ä¸¤ä¸ªæ–¹æ³•ï¼Œå¤„ç†äº¤äº’å’Œå›è°ƒã€‚

å…·ä½“æ­¥éª¤ï¼š

*   é¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ª JavaScript ç±»æˆ–è€…å¯¹è±¡æ¥å°è£… JSBridge æ–¹æ³•ã€‚
    
*   åœ¨ JavaScript ç±»æˆ–å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­ï¼Œåˆå§‹åŒ–æ¡¥æ¥å›è°ƒçš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è´Ÿè´£æ¥æ”¶æ¥è‡ªåŸç”Ÿåº”ç”¨çš„å›è°ƒæ•°æ®ï¼Œå¹¶æ ¹æ®å›è°ƒæ•°æ®ä¸­çš„ä¿¡æ¯æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚
    
*   è°ƒç”¨åŸç”Ÿæ–¹æ³•ï¼šå®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºåœ¨ JavaScript ä¸­è°ƒç”¨åŸç”Ÿæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•éœ€è¦æ¥æ”¶åŸç”Ÿç±»çš„æ˜ å°„ã€è¦è°ƒç”¨çš„åŸç”Ÿæ–¹æ³•åä»¥åŠä¼ é€’ç»™åŸç”Ÿæ–¹æ³•çš„å‚æ•°ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™åŸç”Ÿåº”ç”¨ã€‚
    
*   å¤„ç†åŸç”Ÿå›è°ƒï¼šåœ¨åˆå§‹åŒ–æ¡¥æ¥å›è°ƒçš„æ–¹æ³•ä¸­ï¼Œéœ€è¦å®šä¹‰å¤„ç†åŸç”Ÿå›è°ƒçš„é€»è¾‘ã€‚å½“æ”¶åˆ°åŸç”Ÿåº”ç”¨çš„å›è°ƒæ•°æ®æ—¶ï¼Œæ ¹æ®å›è°ƒæ•°æ®ä¸­çš„ä¿¡æ¯æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œæ¯”å¦‚è°ƒç”¨ JavaScript ä¸­æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¼ é€’æ‰§è¡Œç»“æœæˆ–é”™è¯¯ä¿¡æ¯ç­‰ã€‚
    

å…·ä½“å®ç°ä»£ç ï¼š

*   è°ƒç”¨åŸç”Ÿæ–¹æ³•ï¼š
    

```
// å®šä¹‰ä¸€ä¸ªåä¸º callNative çš„æ–¹æ³•ï¼Œç”¨äºåœ¨ JavaScript ä¸­è°ƒç”¨åŸç”Ÿæ–¹æ³•
callNative<P, R>(classMap: string, method: string, params: P): Promise<R> {
    return new Promise<R>((resolve, reject) => {
        // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„å›è°ƒ ID
        const id = v4();
        // å°†å½“å‰çš„å›è°ƒå‡½æ•°ä¿å­˜åˆ° __callbacks å¯¹è±¡ä¸­ï¼Œä»¥ callbackId ä½œä¸ºé”®
        this.__callbacks[id] = { resolve, reject, method: `${classMap} - ${method}` };
        // æ„é€ é€šä¿¡æ•°æ®ï¼ŒåŒ…æ‹¬åŸç”Ÿç±»æ˜ å°„ã€è¦è°ƒç”¨çš„æ–¹æ³•ã€å‚æ•°å’Œ callbackId 
        const data = {
            classMap,
            method,
            params: params === null ? '' : JSON.stringify(params),
            callbackId: id,
        };
        const dataStr = JSON.stringify(data);
        // æ ¹æ®å½“å‰ç¯å¢ƒåˆ¤æ–­æ˜¯ iOS è¿˜æ˜¯ Androidï¼Œå¹¶è°ƒç”¨ç›¸åº”å¹³å°çš„åŸç”Ÿæ–¹æ³•
        if (this.env.isIOS && isFunction(window?.webkit?.messageHandlers?.callNative?.postMessage)) {
            // å¦‚æœæ˜¯ iOS å¹³å°ï¼Œåˆ™è°ƒç”¨ iOS çš„åŸç”Ÿæ–¹æ³•
            window.webkit.messageHandlers.callNative.postMessage(dataStr);
        } else if (this.env.isAndroid && isFunction(window?.AppFunctions?.callNative)) {
            // å¦‚æœæ˜¯ Android å¹³å°ï¼Œåˆ™è°ƒç”¨ Android çš„åŸç”Ÿæ–¹æ³•
            window.AppFunctions.callNative(dataStr);
        }
    });
}
```

*   å›è°ƒå¤„ç†ï¼š
    

```
// åˆå§‹åŒ–æ¡¥æ¥å›è°ƒå‡½æ•°ï¼Œè¯¥å‚æ•°åœ¨ constructor ä¸­è°ƒç”¨
private initBridgeCallback() {
    // ä¿å­˜æ—§çš„å›è°ƒå‡½æ•°åˆ° oldCallback å˜é‡ä¸­
    const oldCallback = window.callBack;
    // é‡æ–°å®šä¹‰ window.callBack æ–¹æ³•ï¼Œç”¨äºå¤„ç†åŸç”Ÿåº”ç”¨çš„å›è°ƒæ•°æ®
    window.callBack = (data) => {
        // å¦‚æœå­˜åœ¨æ—§çš„å›è°ƒå‡½æ•°ï¼Œåˆ™è°ƒç”¨æ—§çš„å›è°ƒå‡½æ•°
        if (isFunction(oldCallback)) {
            oldCallback(data);
        }
        // è·å–åŸç”Ÿåº”ç”¨çš„å›è°ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®å’Œå›è°ƒ ID
        console.info('native callback', data, data.callbackId);
        // ä»å›è°ƒæ•°æ®ä¸­è·å–å›è°ƒ ID
        const { callbackId } = data;
        // æ ¹æ®å›è°ƒ ID æŸ¥æ‰¾å¯¹åº”çš„å›è°ƒå‡½æ•°
        const callback = this.__callbacks[callbackId];
        // å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„å›è°ƒå‡½æ•°
        if (callback) {
            // å¦‚æœå›è°ƒæ•°æ®ä¸­çš„ code ä¸º 0ï¼Œåˆ™è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨ resolve æ–¹æ³•å¤„ç†æˆåŠŸçš„ç»“æœ
            if (data.code === 0) {
                callback.resolve(data.data);
            } else {
                // å¦åˆ™ï¼Œè¡¨ç¤ºæ‰§è¡Œå¤±è´¥ï¼Œæ„é€ ä¸€ä¸ªé”™è¯¯å¯¹è±¡å¹¶è°ƒç”¨ reject æ–¹æ³•å¤„ç†é”™è¯¯ä¿¡æ¯
                const error = new Error(data.msg) as Error & {response:unknown};
                error.response = data;
                callback.reject(error);
            }
            // åˆ é™¤å·²ç»å¤„ç†è¿‡çš„å›è°ƒå‡½æ•°
            delete this.__callbacks[callbackId];
        }
    };
}
```

*   ä½¿ç”¨ï¼š
    

```
// è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„å°è£…å‡½æ•°
callNative<P, R>(classMap: string, method: string, params: P) {
    // ä»å®¹å™¨ä¸­è§£æå‡º AppBridge å®ä¾‹
    const bridge = container.resolve<AppBridge>(AppBridge);
    // ä½¿ç”¨ bind æ–¹æ³•å°† AppBridge å®ä¾‹ä¸­çš„ callNative æ–¹æ³•ç»‘å®šåˆ° bridge å¯¹è±¡ä¸Šï¼Œå¹¶ä¿å­˜åˆ° func å˜é‡ä¸­
    const func = bridge.callNative.bind(bridge);
    // è°ƒç”¨ func æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ classMapã€method å’Œ params å‚æ•°ï¼Œå®ç°è°ƒç”¨åŸç”Ÿæ–¹æ³•çš„åŠŸèƒ½
    return func<P, R>(classMap, method, params);
}


// æ‰“å¼€ webview
// è°ƒç”¨ callNative æ–¹æ³•ï¼Œä¼ å…¥å‚æ•° urlï¼ŒclassMap ä¸º 'xxxxx/hitch'ï¼Œmethod ä¸º 'openWebview'
openWebView(url: string): Promise<void> {
    return this.callNative<{url:string}, void>('xxxxx/hitch', 'openWebview', { url });
}


// è·å–é©¾é©¶è¯ OCR ä¿¡æ¯
getDriverLicenseOcrInfo(
    params: HBNative.getDriverLicenseOcrInfo.Params,
): Promise<HBNative.getDriverLicenseOcrInfo.Result> {
    // è°ƒç”¨ callNative æ–¹æ³•ï¼Œä¼ å…¥å‚æ•° paramsï¼ŒclassMap ä¸º 'xxxxx/hitch'ï¼Œmethod ä¸º 'getOcrInfo'
    // è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè¯¥ Promise å¯¹è±¡ç”¨äºå¤„ç†å¼‚æ­¥ç»“æœ
    return this.callNative<
        HBNative.getDriverLicenseOcrInfo.Params,
        HBNative.getDriverLicenseOcrInfo.Result>(
            'xxxxx/hitch', 'getOcrInfo', params,
        );
}
```

The End

å¦‚æœä½ è§‰å¾—è¿™ç¯‡å†…å®¹å¯¹ä½ æŒºæœ‰å¯å‘ï¼Œè¯·ä½ è½»è½»ç‚¹ä¸‹å°æ‰‹æŒ‡ï¼Œå¸®æˆ‘ä¸¤ä¸ªå°å¿™å‘—ï¼š

1ã€ç‚¹äº®**ã€Œåœ¨çœ‹ã€**ï¼Œè®©æ›´å¤šçš„äººçœ‹åˆ°è¿™ç¯‡æ»¡æ»¡å¹²è´§çš„å†…å®¹ï¼›

2ã€å…³æ³¨å…¬ä¼—å·ã€Œå“ˆå•°æŠ€æœ¯ã€ï¼Œå¯ç¬¬ä¸€æ—¶é—´æ”¶åˆ°æœ€æ–°æŠ€æœ¯æ¨æ–‡ã€‚

å¦‚æœå–œæ¬¢å°±ç‚¹ä¸ªğŸ‘å–”ï¼Œæœ‰æ‚¨çš„å–œæ¬¢â›½ï¼Œæˆ‘ä»¬ä¼šæ›´æœ‰åŠ¨åŠ›è¾“å‡ºæœ‰ä»·å€¼çš„æŠ€æœ¯åˆ†äº«æ»´ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/xdDaByDutChvEuVqH7YqMpINOLvAvnPRa7WxcazMGJ9TBw8BZcY7aXACCP1775tMGxviaV7XCMOztGobpLJT9BA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)