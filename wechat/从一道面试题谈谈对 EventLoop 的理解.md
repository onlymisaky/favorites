> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3WLuVR4NWnDUOsVQuTSYJw)

> ä½œè€…ï¼šå‰ç«¯è‡ªå­¦é©¿ç«™ï¼ŒåŸæ–‡é“¾æ¥ï¼šhttps://juejin.im/post/6868849475008331783

å‰è¨€
--

å› ä¸ºæ˜é‡‘æ”¹ç‰ˆä¹‹åå¯¹äºå­—æ•°æœ‰äº†ä¸€å®šçš„é™åˆ¶ï¼ˆäº²æµ‹äº†ä¸‹åœ¨ 12500 å­—å·¦å³ï¼Œæ‰€ä»¥çœ‹åˆ°æ ‡é¢˜è¿˜æœ‰å‡ ä¸‡å­—é•¿æ–‡çš„æ ‡é¢˜ä¸€å®šæ˜¯åœ¨å”¬ä½ çš„ğŸ˜‚ï¼‰æ–‡ç« ç¾åŒ–æ’ç‰ˆä¹‹åå­—æ•°è¶…å‡ºäº†é™åˆ¶æ‰€ä»¥æ‰“ç®—å°†åé¢çš„éƒ¨åˆ†å•ç‹¬æ‹å‡ºæ¥å†™, è¿™æ ·ä¹Ÿæ›´å¥½çš„å†™å‡ºç›¸å¯¹æ¯”è¾ƒæ·±å…¥çš„ä¸€ç‚¹çš„å†…å®¹, å¯¹äº`ã€å‰ç«¯ä½“ç³»ã€‘`è¿™ç±»æ–‡ç« å†…å®¹ä¸€å®šæ˜¯åŒ…æ‹¬ä½†ä¸é™äºæ ‡é¢˜çš„ï¼Œæˆ‘ä¼šå°½å¯èƒ½çš„æ‹“å±•ã€æ·±å…¥ã€ä»¥å†™å‡ºé«˜è´¨é‡çš„å¥½æ–‡ç« ã€‚

> åœ¨çº¿å‘å¾®ï¼Œå¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯æ¬¢è¿å¤§å®¶ç‚¹ä¸ªèµğŸ‘»

ä»ä¸€é“é¢˜å¼•å‡ºå¯¹ Event Loop çš„æ€è€ƒ
----------------------

å¯¹äº Event Loop(äº‹ä»¶è½®è¯¢ï¼‰æ‰€æ¶‰åŠçš„çŸ¥è¯†æ¦‚å¿µå¤ªå¤šäº†ï¼Œå¦‚æœä¸Šæ¥å°±è®²ä¸€å¤§å †æ¦‚å¿µæ€§çš„ä¸œè¥¿å¤ªæ¯ç‡¥ä¸”ä»ä¸€å¼€å§‹å°±æ˜¯æŒ‰ç…§æˆ‘çš„æ€è·¯æ¥èµ°çš„ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—æ¢ä¸€ç§æ–¹å¼æ¥å†™è¿™ç¯‡æ–‡ç« ï¼Œä½ å…ˆæŒ‰ç…§ä½ ä¹‹å‰å¯¹äº Event Loop(äº‹ä»¶è½®è¯¢) çš„ç†è§£æ¥è§£è¿™é“é¢˜ï¼Œæˆ‘åœ¨åé¢å†™å‡ºæˆ‘ä» Event Loop çš„ç†è§£æ€è€ƒè¿™é¢˜çš„æ–¹å¼ã€‚ä¸¤ç§ä¸åŒçš„ç†è§£ã€æƒ³æ³•ã€äº’ç›¸ç¢°æ’ï¼Œæˆ‘å¯èƒ½æœ‰ç†è§£ä¸å¯¹çš„ï¼Œä½ ä¹Ÿå¯èƒ½æœ‰ä¹‹å‰å¿½ç•¥çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvZCJWbArD5t8LavGgCsG4YQt0nH9ibicUoKhEqWsorVmvsd2aFfaZwjpQ/640?wx_fmt=png)

ä¸å¥½æ„æ€æ”¾é”™äº†ğŸ˜…ï¼Œè¿™å¼ å›¾

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBv6I1Nm66jGNPsiaQicpx2mo9QfqntoYeLeGticd91J3goCOTOoRyMeic0Rg/640?wx_fmt=png)

### é¢˜ç›®

```
console.log('scriptÂ start');setTimeout(()Â =>Â {Â Â console.log('åŒ—æ­Œ');},Â 1Â *Â 2000);Promise.resolve().then(function()Â {Â Â console.log('promise1');}).then(function()Â {Â Â console.log('promise2');});asyncÂ functionÂ foo()Â {Â Â awaitÂ bar()Â Â console.log('async1Â end')}foo()asyncÂ functionÂ errorFuncÂ ()Â {Â Â tryÂ {Â Â Â Â awaitÂ Promise.reject('error!!!')Â Â }Â catch(e)Â {Â Â Â Â console.log(e)Â Â }Â Â console.log('async1');Â Â returnÂ Promise.resolve('async1Â success')}errorFunc().then(resÂ =>Â console.log(res))functionÂ bar()Â {Â Â console.log('async2Â end')Â }console.log('scriptÂ end');
```

å¥½äº†ï¼Œå¯ä»¥æš‚æ—¶ä¸å¾€ä¸‹ç¿»ï¼Œå…ˆæŒ‰ç…§è‡ªå·±çš„ç†è§£æ¥è§£ä¸‹è¿™é“é¢˜ã€‚

* * *

* * *

* * *

----------------------------------------------------------------------- Â æˆ‘æ˜¯åˆ†å‰²çº¿ -----------------------------------------------------------------------

* * *

* * *

* * *

ç›¸ä¿¡è¿™é“é¢˜è‚¯å®šéš¾ä¸å€’å¤§å®¶ï¼Œä½†æ˜¯å¤§å®¶æ˜¯æŒ‰ç…§ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥è§£å‡ºè¿™é“é¢˜çš„å‘¢ï¼Ÿå…¶å®è¿™é“é¢˜è€ƒå¯Ÿä½ äº†å¾ˆå¤šçŸ¥è¯†ç‚¹ï¼Œä¸‹é¢æˆ‘å°†ç”¨æˆ‘çš„ç†è§£æ¥è¯´è¯´å¯¹è¿™é“é¢˜çš„æ€è€ƒã€‚æ°´å¹³æœ‰é™ã€æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿è¯„è®ºåŒºæŒ‡å‡ºã€‚

JS çš„è¿è¡Œæœºåˆ¶
--------

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvrGc3ARKFBY3jmkSAhdfrc9mhGLPD3enlA8KMWxJazpVrNjCQnrSOqw/640?wx_fmt=png)

å…ˆæ¥è§£é‡Šä¸Šå›¾ä¸­å‡ºç°çš„å‡ ä¸ªå•è¯æ‰€è¦è¡¨è¾¾çš„å«ä¹‰ã€‚

Heap(å †)ã€Stack(æ ˆ)ã€Queue(é˜Ÿåˆ—)ã€Event Loop(äº‹ä»¶è½®è¯¢)

### ç¨‹åºä¸­çš„å †æ ˆé˜Ÿåˆ—

**Heap(å †)**

å †ï¼Œ æ˜¯ä¸€ç§åŠ¨æ€å­˜å‚¨ç»“æ„ï¼Œæ˜¯åˆ©ç”¨å®Œå…¨äºŒå‰æ ‘ç»´æŠ¤çš„ä¸€ç»„æ•°æ®ï¼Œå †åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§ä¸º**æœ€å¤§å †**ï¼Œä¸€ç§ä¸º**æœ€å°å †**ï¼Œå°†æ ¹èŠ‚ç‚¹æœ€å¤§çš„å †å«åš**æœ€å¤§å †**æˆ–**å¤§æ ¹å †**ï¼Œæ ¹èŠ‚ç‚¹æœ€å°çš„å †å«åš**æœ€å°å †**æˆ–**å°æ ¹å †**ã€‚å †æ˜¯**çº¿æ€§æ•°æ®ç»“æ„**ï¼Œç›¸å½“äº**ä¸€ç»´æ•°ç»„**ï¼Œæœ‰å”¯ä¸€åç»§ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvbL3luDHNRSkFzpkET4JibQqmuK3D8an4XWtdshfbM7CjcQWyEXD42ibA/640?wx_fmt=png)

**æ ˆï¼ˆStackï¼‰**

æ ˆåœ¨ç¨‹åºä¸­çš„è®¾å®šæ˜¯é™å®šä»…åœ¨è¡¨å°¾è¿›è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œçš„çº¿æ€§è¡¨ã€‚æ ˆæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒæŒ‰ç…§**åè¿›å…ˆå‡º** (`LIFO: last-in-first-out`) çš„åŸåˆ™å­˜å‚¨æ•°æ®ï¼Œå…ˆè¿›å…¥çš„æ•°æ®è¢«å‹å…¥æ ˆåº•ï¼Œæœ€åçš„æ•°æ®åœ¨æ ˆé¡¶ï¼Œéœ€è¦è¯»æ•°æ®çš„æ—¶å€™ä»æ ˆé¡¶å¼€å§‹å¼¹å‡ºæ•°æ®ã€‚æ ˆæ˜¯åªèƒ½åœ¨æŸä¸€ç«¯æ’å…¥å’Œåˆ é™¤çš„ç‰¹æ®Šçº¿æ€§è¡¨ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvKkstskFTkqje9loYUGxEV4oeuCLUPbUvnO1aJM2mHwbtBOro5s4Mww/640?wx_fmt=png)

**é˜Ÿåˆ—ï¼ˆQueue**ï¼‰

é˜Ÿåˆ—ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒåªå…è®¸åœ¨è¡¨çš„å‰ç«¯ï¼ˆ`front`ï¼‰è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè€Œåœ¨è¡¨çš„åç«¯ï¼ˆ`rear`ï¼‰è¿›è¡Œæ’å…¥æ“ä½œï¼Œå’Œæ ˆä¸€æ ·ï¼Œé˜Ÿåˆ—æ˜¯ä¸€ç§æ“ä½œå—é™åˆ¶çš„çº¿æ€§è¡¨ã€‚è¿›è¡Œæ’å…¥æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå°¾ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå¤´ã€‚Â é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ æ—¶ï¼Œç§°ä¸º**ç©ºé˜Ÿåˆ—**ã€‚

é˜Ÿåˆ—çš„æ•°æ®å…ƒç´ åˆç§°ä¸ºé˜Ÿåˆ—å…ƒç´ ã€‚åœ¨é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå…¥é˜Ÿï¼Œä»é˜Ÿåˆ—ä¸­åˆ é™¤ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå‡ºé˜Ÿã€‚å› ä¸ºé˜Ÿåˆ—åªå…è®¸åœ¨ä¸€ç«¯æ’å…¥ï¼Œåœ¨å¦ä¸€ç«¯åˆ é™¤ï¼Œæ‰€ä»¥åªæœ‰æœ€æ—©è¿›å…¥é˜Ÿåˆ—çš„å…ƒç´ æ‰èƒ½æœ€å…ˆä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œæ•…é˜Ÿåˆ—åˆç§°ä¸º**å…ˆè¿›å…ˆå‡º**ï¼ˆ`FIFO: first-in-first-out`ï¼‰

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvReObVtNuxVeKVkiasM5ZXWpAgV5nBmniaHBbLSFoSckPksu5OJMZ0EQw/640?wx_fmt=png)

### js ä¸­çš„å †æ ˆé˜Ÿåˆ—

ä¸‹é¢æˆ‘è§£é‡Šä¸‹ **JavaScript è¯­è¨€**ä¸­çš„å †ã€æ ˆã€é˜Ÿåˆ—ã€‚

**å †**

å †ï¼Œ åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå¤§å°ä¸å®šä¹Ÿä¸ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå­˜æ”¾**å¼•ç”¨ç±»å‹**ï¼ŒæŒ‡é‚£äº›å¯èƒ½ç”±å¤šä¸ªå€¼æ„æˆçš„å¯¹è±¡ï¼Œä¿å­˜åœ¨å †å†…å­˜ä¸­ï¼ŒåŒ…å«å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œå®é™…ä¸Šä¿å­˜çš„ä¸æ˜¯å˜é‡æœ¬èº«ï¼Œè€Œæ˜¯æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºå­˜å‚¨ä»£ç å—ã€‚

å †çš„ä½œç”¨ï¼šå­˜å‚¨å¼•ç”¨ç±»å‹å€¼çš„æ•°æ®

```
letÂ objÂ =Â {Â Â Â Â name:Â 'åŒ—æ­Œ'ï¼ŒÂ Â Â Â puslic:Â 'å‰ç«¯è‡ªå­¦é©¿ç«™'}letÂ funcÂ =Â ()Â =>Â {Â Â Â Â console.log('helloÂ world')}
```

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvAGrTPBkGZ88top3qpsrmz8M2cFXoC1BZsyyISiaibdickuKReIn0op1Jw/640?wx_fmt=png)

**æ ˆ**

js ä¸­çš„æ ˆå‡†ç¡®æ¥å°†åº”è¯¥å«è°ƒç”¨æ ˆ (EC Stack)ï¼Œä¼šè‡ªåŠ¨åˆ†é…å†…å­˜ç©ºé—´ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå­˜æ”¾**åŸºæœ¬ç±»å‹**ï¼Œç®€å•çš„æ•°æ®æ®µï¼Œå æ®å›ºå®šå¤§å°çš„ç©ºé—´ã€‚

æ ˆçš„ä½œç”¨ï¼šå­˜å‚¨åŸºæœ¬ç±»å‹å€¼ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆè¦çš„ä½œç”¨ã€‚**æä¾›ä»£ç æ‰§è¡Œçš„ç¯å¢ƒ**

**é˜Ÿåˆ—**

js ä¸­çš„é˜Ÿåˆ—å¯ä»¥å«åš**ä»»åŠ¡é˜Ÿåˆ—**æˆ–**å¼‚æ­¥é˜Ÿåˆ—**ï¼Œä»»åŠ¡é˜Ÿåˆ—é‡Œå­˜æ”¾å„ç§å¼‚æ­¥æ“ä½œæ‰€æ³¨å†Œçš„å›è°ƒï¼Œé‡Œé¢åˆ†ä¸ºä¸¤ç§ä»»åŠ¡ç±»å‹ï¼Œå®ä»»åŠ¡ (`macroTask`) å’Œå¾®ä»»åŠ¡ (`microTask`)ã€‚

å¥½ï¼Œä¸‹é¢å¯ä»¥å›åˆ°æ­£é¢˜ä¸Šæ¥äº†ã€‚

### ä¸ºä»€ä¹ˆä¼šå‡ºç° Event Loop

æ€»æ‰€å‘¨çŸ¥ JS æ˜¯ä¸€é—¨å•çº¿ç¨‹çš„éé˜»å¡è„šæœ¬è¯­è¨€ï¼ŒEvent Loop å°±æ˜¯ä¸ºäº†è§£å†³ JS å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvHIgjZJP0WLgn807jLoaaNBlib8b0WeHE6JXJbBWyghLvwiaqXVLneAQQ/640?wx_fmt=png)

### JS ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œé‚£å®ƒæ˜¯æ€ä¹ˆå®ç°å¼‚æ­¥ç¼–ç¨‹ (éé˜»å¡) è¿è¡Œçš„

ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šJavaScript çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†å¤„ç†æµè§ˆå™¨ç½‘é¡µçš„äº¤äº’ï¼ˆDOM æ“ä½œçš„å¤„ç†ã€UI åŠ¨ç”»ç­‰), Â è®¾è®¡æˆå•çº¿ç¨‹çš„åŸå› å°±æ˜¯ä¸æƒ³è®©æµè§ˆå™¨å˜å¾—å¤ªå¤æ‚ï¼Œå› ä¸ºå¤šçº¿ç¨‹éœ€è¦å…±äº«èµ„æºã€ä¸”æœ‰å¯èƒ½ä¿®æ”¹å½¼æ­¤çš„è¿è¡Œç»“æœï¼ˆä¸¤ä¸ªçº¿ç¨‹ä¿®æ”¹äº†åŒä¸€ä¸ª DOM èŠ‚ç‚¹å°±ä¼šäº§ç”Ÿä¸å¿…è¦çš„éº»çƒ¦ï¼‰ï¼Œè¿™å¯¹äºä¸€ç§ç½‘é¡µè„šæœ¬è¯­è¨€æ¥è¯´è¿™å°±å¤ªå¤æ‚äº†ã€‚

ç¬¬äºŒä¸ªé—®é¢˜ï¼šJavaScript æ˜¯å•çº¿ç¨‹çš„ä½†å®ƒæ‰€è¿è¡Œçš„å®¿ä¸»ç¯å¢ƒâ€”æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹ï¼Œæµè§ˆå™¨æä¾›äº†å„ç§çº¿ç¨‹ä¾› Event Loop è°ƒåº¦æ¥åè°ƒ JS å•çº¿ç¨‹è¿è¡Œæ—¶ä¸ä¼šé˜»å¡ã€‚

### å°ç»“

å…ˆæ€»ç»“ä¸€æ³¢ä¸ªäººå¯¹äº JS è¿è¡Œæœºåˆ¶çš„ç†è§£ï¼š

> ä»£ç æ‰§è¡Œå¼€å¯ä¸€ä¸ªå…¨å±€è°ƒç”¨æ ˆ (ä¸»æ ˆ) æä¾›ä»£ç è¿è¡Œçš„ç¯å¢ƒï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»»åŠ¡çš„ä»£ç ç«‹å³æ‰§è¡Œï¼Œé‡åˆ°å¼‚æ­¥ä»»åŠ¡å°†å¼‚æ­¥çš„å›è°ƒæ³¨å†Œåˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•æŸ¥çœ‹å¼‚æ­¥æ˜¯å¦å®Œæˆï¼Œå¦‚æœå®Œæˆå°†å½“å‰å¼‚æ­¥ä»»åŠ¡çš„å›è°ƒæ‹¿åˆ°ä¸»æ ˆä¸­æ‰§è¡Œ

è¿›ç¨‹å’Œçº¿ç¨‹
-----

è¿›ç¨‹ï¼šè¿›ç¨‹æ˜¯ CPU èµ„æºåˆ†é…çš„æœ€å°å•ä½ (æ˜¯èƒ½æ‹¥æœ‰èµ„æºå’Œç‹¬ç«‹è¿è¡Œçš„æœ€å°å•ä½)

çº¿ç¨‹ï¼šçº¿ç¨‹æ˜¯ CPU è°ƒåº¦çš„æœ€å°å•ä½ (çº¿ç¨‹æ˜¯å»ºç«‹åœ¨è¿›ç¨‹çš„åŸºç¡€ä¸Šçš„ä¸€æ¬¡ç¨‹åºè¿è¡Œå•ä½)

å¯¹äºè¿›ç¨‹å’Œçº¿ç¨‹å¹¶æ²¡æœ‰ç¡®åˆ‡ç»Ÿä¸€çš„æè¿°ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ï¼š

> æ¯”å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åº: å¦‚ QQã€æµè§ˆå™¨å¯åŠ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œè¯¥è¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹æ¥è¿›è¡Œèµ„æºè°ƒåº¦å’Œåˆ†é…ï¼Œè¾¾åˆ°è¿è¡Œç¨‹åºçš„ä½œç”¨ã€‚
> 
> æ›´é€šä¿—çš„è¯è®²ï¼šæ‰“å¼€ QQ åº”ç”¨ç¨‹åºå¼€å¯äº†è¿›ç¨‹æ¥è¿è¡Œç¨‹åº (QQ), æœ‰å¤šä¸ªçº¿ç¨‹æ¥è¿›è¡Œèµ„æºè°ƒåº¦å’Œåˆ†é…(å¤šä¸ªçº¿ç¨‹æ¥åˆ†é…æ‰“å¼€ QQ æ‰€å ç”¨çš„è¿å­˜)ï¼Œè¾¾åˆ°è¿è¡Œç¨‹åº(QQ) çš„ä½œç”¨.

ç”¨æ“ä½œç³»ç»Ÿæ¥ä½œä¸ªä¾‹å­ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvibOa2ibCicq4jDkf8jiaoUxL5OuaYyYU5icu7voficxIKtCKNuWTG0e68IMQ/640?wx_fmt=png)

> çº¿ç¨‹ä¾èµ–è¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯çº¿ç¨‹åªèƒ½æ˜¯å±äºä¸€ä¸ªè¿›ç¨‹ã€‚

### JS çš„å•çº¿ç¨‹

js çš„å•çº¿ç¨‹æŒ‡çš„æ˜¯ javaScript å¼•æ“åªæœ‰ä¸€ä¸ªçº¿ç¨‹

å•çº¿ç¨‹å°±æ„å‘³ç€ï¼Œæ‰€æœ‰ä»»åŠ¡éœ€è¦æ’é˜Ÿï¼Œå‰ä¸€ä¸ªä»»åŠ¡ç»“æŸï¼Œæ‰ä¼šæ‰§è¡Œåä¸€ä¸ªä»»åŠ¡ã€‚å¦‚æœå‰ä¸€ä¸ªä»»åŠ¡è€—æ—¶å¾ˆé•¿ï¼Œåä¸€ä¸ªä»»åŠ¡å°±ä¸å¾—ä¸ä¸€ç›´ç­‰ç€ã€‚js å¼•æ“æ‰§è¡Œå¼‚æ­¥ä»£ç è€Œä¸ç”¨ç­‰å¾…ï¼Œæ˜¯å› æœ‰ä¸ºæœ‰ä»»åŠ¡é˜Ÿåˆ—å’Œäº‹ä»¶è½®è¯¢ã€‚

*   ä»»åŠ¡é˜Ÿåˆ—ï¼šä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå®ƒé‡Œé¢å­˜æ”¾ç€å„ç§ä»»åŠ¡å›è°ƒã€‚
    
*   äº‹ä»¶è½®è¯¢ï¼šäº‹ä»¶è½®è¯¢æ˜¯æŒ‡ä¸»çº¿ç¨‹é‡å¤ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ã€‚
    

### æµè§ˆå™¨çš„å¤šçº¿ç¨‹

1.  GUI æ¸²æŸ“çº¿ç¨‹
    

*   ç»˜åˆ¶é¡µé¢ï¼Œè§£æ HTMLã€CSSï¼Œæ„å»º DOM æ ‘ï¼Œå¸ƒå±€å’Œç»˜åˆ¶ç­‰
    
*   é¡µé¢é‡ç»˜å’Œå›æµ
    
*   ä¸ JS å¼•æ“çº¿ç¨‹äº’æ–¥ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ JS æ‰§è¡Œé˜»å¡é¡µé¢æ›´æ–°
    

3.  JS å¼•æ“çº¿ç¨‹
    

*   è´Ÿè´£ JS è„šæœ¬ä»£ç çš„æ‰§è¡Œ
    
*   è´Ÿè´£å‡†æ‰§è¡Œå‡†å¤‡å¥½å¾…æ‰§è¡Œçš„äº‹ä»¶ï¼Œå³å®šæ—¶å™¨è®¡æ•°ç»“æŸï¼Œæˆ–å¼‚æ­¥è¯·æ±‚æˆåŠŸå¹¶æ­£ç¡®è¿”å›çš„äº‹ä»¶
    
*   ä¸ GUI æ¸²æŸ“çº¿ç¨‹äº’æ–¥ï¼Œæ‰§è¡Œæ—¶é—´è¿‡é•¿å°†é˜»å¡é¡µé¢çš„æ¸²æŸ“
    

5.  äº‹ä»¶è§¦å‘çº¿ç¨‹
    

*   è´Ÿè´£å°†å‡†å¤‡å¥½çš„äº‹ä»¶äº¤ç»™ JS å¼•æ“çº¿ç¨‹æ‰§è¡Œ
    
*   å¤šä¸ªäº‹ä»¶åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ—¶å€™éœ€è¦æ’é˜Ÿç­‰å¾… (JS çš„å•çº¿ç¨‹)
    

7.  å®šæ—¶å™¨è§¦å‘çº¿ç¨‹
    

*   è´Ÿè´£æ‰§è¡Œå¼‚æ­¥çš„å®šæ—¶å™¨ç±»çš„äº‹ä»¶ï¼Œå¦‚ setTimeoutã€setInterval
    
*   å®šæ—¶å™¨åˆ°æ—¶é—´ä¹‹åæŠŠæ³¨å†Œçš„å›è°ƒåŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾
    

9.  HTTP è¯·æ±‚çº¿ç¨‹
    

*   è´Ÿè´£æ‰§è¡Œå¼‚æ­¥è¯·æ±‚
    
*   ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç é‡åˆ°å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ä¼šæŠŠå‡½æ•°äº¤ç»™è¯¥çº¿ç¨‹å¤„ç†ï¼Œå½“ç›‘å¬åˆ°çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œå¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œè¯¥çº¿ç¨‹ä¼šæŠŠå›è°ƒå‡½æ•°åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ç­‰å¾…æ‰§è¡Œ
    

Event Loop
----------

å‘¼ï¼Œç»ˆäºå›åˆ°æ­£é¢˜äº†ï¼

å¯¹äºäº‹ä»¶è½®è¯¢ä¸Šé¢å…¶å®å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼š

> äº‹ä»¶è½®è¯¢å°±æ˜¯è§£å†³ javaScript å•çº¿ç¨‹å¯¹äºå¼‚æ­¥æ“ä½œçš„ä¸€äº›ç¼ºé™·ï¼Œè®© javaScript åšåˆ°æ—¢æ˜¯**å•çº¿ç¨‹**ï¼Œåˆç»å¯¹**ä¸ä¼šé˜»å¡**çš„æ ¸å¿ƒæœºåˆ¶ï¼Œæ˜¯ç”¨æ¥åè°ƒå„ç§äº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬æ‰§è¡Œã€UI æ¸²æŸ“ã€ç½‘ç»œè¯·æ±‚ç­‰çš„ä¸€ç§æœºåˆ¶ã€‚

### æµè§ˆå™¨ä¸­çš„ Eveent Loop æ‰§è¡Œé¡ºåº

Processing model[1] è§„èŒƒå®šä¹‰äº†`Eveent Loop`çš„å¾ªç¯è¿‡ç¨‹ï¼š

ä¸€ä¸ª Eveent Loop åªè¦å­˜åœ¨ï¼Œå°±ä¼šä¸æ–­æ‰§è¡Œä¸‹è¾¹çš„æ­¥éª¤ï¼š

*   1. åœ¨ tasks(ä»»åŠ¡) é˜Ÿåˆ—ä¸­é€‰æ‹©æœ€è€çš„ä¸€ä¸ª task, ç”¨æˆ·ä»£ç†å¯ä»¥é€‰æ‹©ä»»ä½• task é˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰å¯é€‰çš„ä»»åŠ¡ï¼Œåˆ™è·³åˆ°ä¸‹è¾¹çš„ microtasks æ­¥éª¤ã€‚
    
*   2. å°†ä¸Šè¾¹é€‰æ‹©çš„ task è®¾ç½®ä¸ºæ­£åœ¨è¿è¡Œçš„ task[2]ã€‚
    
*   3.Run: è¿è¡Œè¢«é€‰æ‹©çš„ taskã€‚
    
*   4. å°† Eveent Loop çš„ currently running task[3] å˜ä¸º nullã€‚
    
*   5. ä» task é˜Ÿåˆ—é‡Œç§»é™¤å‰è¾¹è¿è¡Œçš„ taskã€‚
    
*   6.Microtasks: æ‰§è¡Œ microtasks ä»»åŠ¡æ£€æŸ¥ç‚¹ [4]ã€‚ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œ microtasks é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼‰
    
*   7. æ›´æ–°æ¸²æŸ“ï¼ˆUpdate the renderingï¼‰ï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºæµè§ˆå™¨æ¸²æŸ“...
    
*   8. å¦‚æœè¿™æ˜¯ä¸€ä¸ª worker event loopï¼Œä½†æ˜¯æ²¡æœ‰ä»»åŠ¡åœ¨ task é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸” WorkerGlobalScope[5] å¯¹è±¡çš„ closing æ ‡è¯†ä¸º trueï¼Œåˆ™é”€æ¯ Eveent Loopï¼Œä¸­æ­¢è¿™äº›æ­¥éª¤ï¼Œç„¶åè¿›è¡Œå®šä¹‰åœ¨ Web workers[6] ç« èŠ‚çš„ run a worker[7]ã€‚
    
*   9. è¿”å›åˆ°ç¬¬ä¸€æ­¥ã€‚
    

Eveent Loopp ä¼šä¸æ–­å¾ªç¯ä¸Šé¢çš„æ­¥éª¤ï¼Œæ¦‚æ‹¬è¯´æ¥ï¼š

*   `Eveent Loop`ä¼šä¸æ–­å¾ªç¯çš„å»å–`tasks`é˜Ÿåˆ—çš„ä¸­æœ€è€çš„ä¸€ä¸ª task(å¯ä»¥ç†è§£ä¸ºå®ä»»åŠ¡ï¼‰æ¨å…¥æ ˆä¸­æ‰§è¡Œï¼Œå¹¶åœ¨å½“æ¬¡å¾ªç¯é‡Œä¾æ¬¡æ‰§è¡Œå¹¶æ¸…ç©º`microtask`é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚
    
*   æ‰§è¡Œå®Œ`microtask`é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œæœ‰**å¯èƒ½**ä¼šæ¸²æŸ“æ›´æ–°ã€‚ï¼ˆæµè§ˆå™¨å¾ˆèªæ˜ï¼Œåœ¨ä¸€å¸§ä»¥å†…çš„å¤šæ¬¡ dom å˜åŠ¨æµè§ˆå™¨ä¸ä¼šç«‹å³å“åº”ï¼Œè€Œæ˜¯ä¼šç§¯æ”’å˜åŠ¨ä»¥æœ€é«˜ 60HZ(å¤§çº¦ 16.7ms æ¯å¸§) çš„é¢‘ç‡æ›´æ–°è§†å›¾ï¼‰
    

### å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ä¼˜å…ˆé—®é¢˜

> åœ¨ä»»åŠ¡å¯¹åˆ— (queue) ä¸­æ³¨å†Œçš„å¼‚æ­¥å›è°ƒåˆåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ç†è§£å¯ä»¥è®¤ä¸ºåœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰å®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚å®ä»»åŠ¡é˜Ÿåˆ—æœ‰å¤šä¸ªï¼Œå¾®ä»»åŠ¡åªæœ‰ä¸€ä¸ª

*   å®ä»»åŠ¡ (macro Task)
    

*   script(æ•´ä½“ä»£ç )
    
*   setTimeout/setInterval
    
*   setImmediate(Node ç¯å¢ƒ)
    
*   UI æ¸²æŸ“
    
*   requestAnimationFrame
    
*   ....
    

*   å¾®ä»»åŠ¡ (micro Task)
    

*   Promise çš„ then()ã€catch()ã€finally() é‡Œé¢çš„å›è°ƒ
    
*   process.nextTick(Node ç¯å¢ƒï¼‰
    
*   ...
    

ä¸ªäººç†è§£çš„æ‰§è¡Œé¡ºåºï¼š

1.  ä»£ç ä»å¼€å§‹æ‰§è¡Œè°ƒç”¨ä¸€ä¸ªå…¨å±€æ‰§è¡Œæ ˆï¼Œscript æ ‡ç­¾ä½œä¸ºå®ä»»åŠ¡æ‰§è¡Œ
    
2.  æ‰§è¡Œè¿‡ç¨‹ä¸­åŒæ­¥ä»£ç ç«‹å³æ‰§è¡Œï¼Œå¼‚æ­¥ä»£ç æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡é˜Ÿåˆ—å­˜æ”¾æœ‰ä¸¤ç§ç±»å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
    
3.  åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ä¹Ÿå°±æ„å‘³ç€ç¬¬ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæ¯• (script)
    

*   1ã€å…ˆæŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡
    
    1-1ã€æœ‰çš„è¯å°±å°†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡æ¸…ç©º
    
    2-2ã€å¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåœ¨æ­¤æ¬¡æ‰§è¡Œä¸­ä¸€å¹¶æ¸…ç©º
    
*   2ã€å¦‚æœæ²¡æœ‰å†çœ‹çœ‹å®ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰æ²¡æœ‰å®ä»»åŠ¡ï¼Œæœ‰çš„è¯æ‰§è¡Œï¼Œæ²¡æœ‰çš„è¯äº‹ä»¶è½®è¯¢ç¬¬ä¸€æ³¢ç»“æŸ
    
    2-1ã€æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—
    
    2-2ã€å®Œæˆå®ä»»åŠ¡ä¹‹åæ‰§è¡Œæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»£ç 
    

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvrFIPQPwhzaEF69vbdB91pkg1vrEtLgd5QjMEOVf0UoxZicibb3SRgCFQ/640?wx_fmt=png)

> æ‰€ä»¥æ˜¯å®ä»»åŠ¡ä¼˜å…ˆï¼Œåœ¨å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ä¼šæ¥ä¸€æ¬¡æ€§æ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ã€‚

### è§£é¢˜åˆ†æè¿‡ç¨‹

å°†æœ€å¼€å§‹çš„é‚£é“é¢˜æ¬ä¸‹æ¥

```
//Â =>Â ä»£ç ä¸€æ‰§è¡Œå°±å¼€å§‹æ‰§è¡Œäº†ä¸€ä¸ªå®ä»»åŠ¡-å®0console.log('scriptÂ start');Â setTimeout(()Â =>Â {Â //Â å®Â 1Â Â console.log('åŒ—æ­Œ');},Â 1Â *Â 2000);Promise.resolve()Â Â Â Â .then(function()Â {Â //Â å¾®1-1Â Â Â Â Â Â console.log('promise1');Â Â Â Â })Â Â Â Â .then(function()Â {Â //Â å¾®1-4 =>Â è¿™ä¸ªthenä¸­çš„ä¼šç­‰å¾…ä¸Šä¸€ä¸ªthenæ‰§è¡Œå®Œæˆä¹‹åå¾—åˆ°å…¶çŠ¶æ€æ‰ä¼šå‘Queueæ³¨å†ŒçŠ¶æ€å¯¹åº”çš„å›è°ƒï¼Œå‡è®¾ä¸Šä¸€ä¸ªthenä¸­ä¸»åŠ¨æŠ›é”™ä¸”æ²¡æœ‰æ•è·ï¼Œé‚£å°±æ³¨å†Œçš„æ˜¯è¿™ä¸ªthenä¸­çš„ç¬¬äºŒä¸ªå›è°ƒäº†ã€‚Â Â Â Â Â Â console.log('promise2');Â Â Â Â Â });asyncÂ functionÂ foo()Â {Â Â awaitÂ bar()Â //Â =>Â await(promiseçš„è¯­æ³•ç³–)ï¼Œä¼šå¼‚æ­¥ç­‰å¾…è·å–å…¶è¿”å›å€¼Â Â //Â =>Â åé¢çš„ä»£ç å¯ä»¥ç†è§£ä¸ºæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—å¾®ä»»åŠ¡ä¸­ã€‚Â è¿™é‡Œå¯ä»¥ä¿ç•™ç–‘é—®åé¢ä¼šè¯¦ç»†è¯´Â Â console.log('async1Â end')Â //Â å¾®1-2}foo()functionÂ bar()Â {Â Â console.log('async2Â end')Â }asyncÂ functionÂ errorFuncÂ ()Â {Â Â tryÂ {Â Â Â Â awaitÂ Promise.reject('error!!!')Â Â }Â catch(e)Â {Â Â Â Â Â Â //Â =>Â ä»è¿™åé¢å¼€å§‹æ‰€æœ‰çš„ä»£ç å¯ä»¥ç†è§£ä¸ºæ”¾åˆ°å¼‚æ­¥é˜Ÿåˆ—å¾®ä»»åŠ¡ä¸­Â Â Â Â console.log(e)Â Â //Â å¾®1-3Â Â }Â Â console.log('async1');Â Â returnÂ Promise.resolve('async1Â success')}errorFunc().then(resÂ =>Â console.log(res))Â //Â å¾®1-5console.log('scriptÂ end');
```

ä¸Šé¢ä»£ç å¯¹äº Promise çš„ç”¨æ³•æˆ‘å°±ä¸å¤šè®²äº†, åœ¨åé¢æˆ‘ä¼šå†™å…³äº Promise æºç è§£æçš„æ–‡ç« ã€‚

æ³¨æ„ä¸€ç‚¹å°±æ˜¯ Promise.then().then()ï¼Œåœ¨æ³¨å†Œå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™ï¼Œç¬¬äºŒä¸ª then ä¸­çš„å›è°ƒæ˜¯ä¾èµ–ç¬¬ä¸€ä¸ª then ä¸­å›è°ƒçš„ç»“æœçš„ï¼Œå¦‚æœæ‰§è¡Œæ²¡æœ‰å¼‚å¸¸æ‰ä¼šåœ¨è¯¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åæ³¨å†ŒçŠ¶æ€å¯¹åº”çš„å›è°ƒ

#### ç¬¬ä¸€æ¬¡æ‰§è¡Œ

å…¨å±€ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ, è¾“å‡ºåŒæ­¥ä»£ç ã€‚æŒ‚è½½å® 1ã€å¾® 1-1ã€å¾® 1-2ã€å¾® 1-3ã€å¾® 1-4ã€‚1 - è¡¨ç¤ºå±äºç¬¬ä¸€æ¬¡è½®è¯¢

```
run:Â scriptÂ startã€Â async2Â endã€scriptÂ end
```

#### ç¬¬äºŒæ¬¡æ‰§è¡Œ

åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»£ç ã€‚

**å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¸”ä¼šåœ¨å½“å‰è½®è¯¢ä¸€æ¬¡æ¸…ç©º**

```
run:Â æ‰§è¡Œå¾®1-1:Â promise1Â æ‰§è¡Œå¾®1-2:Â async1Â endÂ æ‰§è¡Œå¾®1-3: error!!!ã€async1 ã€‚å½“å‰å¼‚æ­¥å›è°ƒæ‰§è¡Œå®Œæ¯•æ‰Promise.resolve('async1Â success')ï¼Œç„¶åæ³¨å†Œthen()ä¸­çš„æˆåŠŸçš„å›è°ƒ-å¾®1-5Â æ‰§è¡Œå¾®1-4:Â promise2Â Â Â Â æ‰§è¡Œåˆšåˆšæ³¨å†Œçš„å¾®1-5:Â async1Â success
```

**åˆ°è¿™ç¬¬ä¸€æ³¢è½®è¯¢ç»“æŸ**

#### ç¬¬ä¸‰æ¬¡æ‰§è¡Œ

å¼€å¯ç¬¬äºŒæ³¢è½®è¯¢ï¼šæ‰§è¡Œå® 1

```
run:Â 'åŒ—æ­Œ'
```

åˆ°è¿™ã€‚æ•´ä¸ªè½®è¯¢ç»“æŸã€‚

> å…¶å®ç›¸å¯¹éš¾ä»¥ç†è§£çš„ä¹Ÿå°±æ˜¯å¾®ä»»åŠ¡ï¼Œå¯¹äºå¾®ä»»åŠ¡ä¹Ÿå°±æ˜¯ä¸Šé¢è¯´çš„åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä¼šåœ¨**æ­¤æ¬¡**è½®è¯¢ä¸­ä¸€æ¬¡æ¸…ç©º (åŒ…æ‹¬**æ­¤æ¬¡**æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å¾®ä»»åŠ¡)ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°

ä½ å»å ‚é£Ÿæ’é˜Ÿæ‰“èœï¼ŒåŸæœ¬ä½ è®¡åˆ’ä»Šå¤©åªåƒä¸¤ä¸ªèœ (å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­åªæ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒ)ï¼Œåœ¨æ‰“èœçš„è¿‡ç¨‹ä¸­ä½ çœ‹åˆ°ä½ æœ€å–œæ¬¢åƒçš„çº¢çƒ§è‚‰ (å¾®ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„æ–°çš„å¾®ä»»åŠ¡)ï¼Œä½ è‚¯å®šå¾—å†åŠ ä¸ªèœ (å°†å¾®ä»»åŠ¡åŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—)

æ‰“æ€ªè¿›é˜¶
----

é€šè¿‡ä¸Šé¢çš„è®²è§£ç°åœ¨å¯ä»¥åˆ·å‡ é“é¢˜æ¥çœ‹çœ‹è‡ªå·±æ’‘æ¡çš„æ€ä¹ˆæ ·äº†ã€‚

### é»„é‡‘é¢˜

```
console.log('1');setTimeout(()Â =>Â {Â Â console.log('2');Â Â Promise.resolve().then(()Â =>Â {Â Â Â Â console.log('3');Â Â })Â Â newÂ Promise((resolve)Â =>Â {Â Â Â Â console.log('4');Â Â Â Â resolve();Â Â }).then(()Â =>Â {Â Â Â Â console.log('5')Â Â })})Promise.reject().then(()Â =>Â {Â Â console.log('13');},Â ()Â =>Â {Â Â console.log('12');})newÂ Promise((resolve)Â =>Â {Â Â console.log('7');Â Â resolve();}).then(()Â =>Â {Â Â console.log('8')})setTimeout(()Â =>Â {Â Â console.log('9');Â Â Promise.resolve().then(()Â =>Â {Â Â Â Â console.log('10');Â Â })Â Â newÂ Promise((resolve)Â =>Â {Â Â Â Â console.log('11');Â Â Â Â resolve();Â Â }).then(()Â =>Â {Â Â Â Â console.log('12')Â Â })})
```

### ç –çŸ³é¢˜

```
newÂ Promise((resolve,Â reject)Â =>Â {Â Â Â Â console.log(1)Â Â Â Â resolve()Â Â })Â Â .then(()Â =>Â {Â Â Â Â console.log(2)Â Â Â Â newÂ Promise((resolve,Â reject)Â =>Â {Â Â Â Â Â Â Â Â console.log(3)Â Â Â Â Â Â Â Â setTimeout(()Â =>Â {Â Â Â Â Â Â Â Â Â Â reject();Â Â Â Â Â Â Â Â },Â 3Â *Â 1000);Â Â Â Â Â Â Â Â resolve()Â Â Â Â })Â Â Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â Â Â console.log(4)Â Â Â Â Â Â Â Â newÂ Promise((resolve,Â reject)Â =>Â {Â Â Â Â Â Â Â Â Â Â Â Â console.log(5)Â Â Â Â Â Â Â Â Â Â Â Â resolve();Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â Â Â Â Â Â Â console.log(7)Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â Â Â Â Â Â Â console.log(9)Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â })Â Â Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â Â Â console.log(8)Â Â Â Â Â Â })Â Â })Â Â .then(()Â =>Â {Â Â Â Â console.log(6)Â Â })
```

### ç‹è€…é¢˜

```
Promise.resolve()Â Â .then(()Â =>Â {Â Â Â Â console.log('promise1');Â Â Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {Â Â Â Â Â Â Â Â setTimeout(()Â =>Â {Â Â Â Â Â Â Â Â Â Â console.log('timer2')Â Â Â Â Â Â Â Â Â Â resolve()Â Â Â Â Â Â Â Â },Â 0)Â Â Â Â })Â Â Â Â Â Â .then(asyncÂ ()Â =>Â {Â Â Â Â Â Â Â Â awaitÂ foo();Â Â Â Â Â Â Â Â returnÂ newÂ Error('error1')Â Â Â Â Â Â })Â Â Â Â Â Â .then((ret)Â =>Â {Â Â Â Â Â Â Â Â setTimeout(()Â =>Â {Â Â Â Â Â Â Â Â Â Â console.log(ret);Â Â Â Â Â Â Â Â Â Â Promise.resolve()Â Â Â Â Â Â Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â Â Â Â Â Â Â returnÂ newÂ Error('error!!!')Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â Â Â Â .then(resÂ =>Â {Â Â Â Â Â Â Â Â Â Â Â Â console.log("then:Â ",Â res)Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â Â Â Â .catch(errÂ =>Â {Â Â Â Â Â Â Â Â Â Â Â Â console.log("catch:Â ",Â err)Â Â Â Â Â Â Â Â Â Â })Â Â Â Â Â Â Â Â },Â 1Â *Â 3000)Â Â Â Â Â Â },Â errÂ =>Â {Â Â Â Â Â Â Â Â console.log(err);Â Â Â Â Â Â })Â Â Â Â Â Â .finally((res)Â =>Â {Â Â Â Â Â Â Â Â console.log(res);Â Â Â Â Â Â Â Â throwÂ newÂ Error('error2')Â Â Â Â Â Â })Â Â Â Â Â Â .then((res)Â =>Â {Â Â Â Â Â Â Â Â console.log(res);Â Â Â Â Â Â },Â errÂ =>Â {Â Â Â Â Â Â Â Â console.log(err);Â Â Â Â Â Â })Â Â })Â Â .then(()Â =>Â {Â Â Â Â console.log('promise2');Â Â })functionÂ foo()Â {Â Â setTimeout(()Â =>Â {Â Â Â Â Â console.log('async1');Â Â },Â 2Â *Â 1000);}setTimeout(()Â =>Â {Â Â console.log('timer1')Â Â Promise.resolve()Â Â Â Â .then(()Â =>Â {Â Â Â Â Â Â console.log('promise3')Â Â Â Â })},Â 0)console.log('start');
```

### è£è€€ç‹è€…

ä¸‹é¢è®©æˆ‘ä»¬æ¥ä¸€èµ·åšæœ€åè¿™é“é¢˜ã€‚

```
asyncÂ functionÂ async1()Â {Â Â console.log('async1Â start');Â Â newÂ Promise((resolve,Â reject)Â =>Â {Â Â Â Â tryÂ {Â Â Â Â Â Â throwÂ newÂ Error('error1')Â Â Â Â }Â catch(e)Â {Â Â Â Â Â Â console.log(e);Â Â Â Â }Â Â Â Â setTimeout(()Â =>Â {Â //Â å®3Â Â Â Â Â Â resolve('promise4')Â Â Â Â },Â 3Â *Â 1000);Â Â })Â Â Â Â .then((res)Â =>Â {Â //Â å¾®3-1Â Â Â Â Â Â console.log(res);Â Â Â Â },Â errÂ =>Â {Â Â Â Â Â Â console.log(err);Â Â Â Â })Â Â Â Â .finally(resÂ =>Â {Â //Â å¾®3-2Â //Â TODOæ³¨3Â Â Â Â Â Â console.log(res);Â Â Â Â })Â Â console.log(awaitÂ async2());Â //Â TODO-æ³¨1Â Â console.log('async1Â end');Â //Â å¾®1-1Â //Â TODO-æ³¨2}functionÂ async2()Â {Â Â console.log('async2');Â Â returnÂ newÂ Promise((resolve)Â =>Â {Â Â Â Â setTimeout(()Â =>Â {Â //Â å®4Â Â Â Â Â Â resolve(2)Â Â Â Â },Â 1Â *Â 3000);Â Â })}console.log('scriptÂ start');setTimeout(()Â =>Â {Â //Â å®2Â Â console.log('setTimeout');},Â 0)async1();newÂ Promise((resolve)Â =>Â {Â Â console.log('promise1');Â Â resolve();})Â Â .then(()Â =>Â {Â //Â å¾®1-2Â Â Â Â console.log('promise2');Â Â Â Â returnÂ newÂ Promise((resolve)Â =>Â {Â Â Â Â Â Â resolve()Â Â Â Â })Â Â Â Â Â Â .then(()Â =>Â {Â //Â å¾®1-3Â Â Â Â Â Â Â Â console.log('thenÂ 1-1')Â Â Â Â Â Â })Â Â })Â Â .then(()Â =>Â {Â //Â å¾®1-4Â Â Â Â console.log('promise3');Â Â })console.log('scriptÂ end');
```

#### è§„å®š

ç°åœ¨ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè¯·è®°ä½ä¸€ä¸‹è§„å®šï¼š

*   åˆ†æä»¥æ¯æ¬¡è½®è¯¢åšä¸ºåˆ†æï¼ŒåŒæ­¥ä»£ç å—æ˜¯ç›´æ¥è¾“å‡ºç»“æœçš„
    
*   å¼‚æ­¥ä»»åŠ¡ä»£ç å—ä¸­ï¼Œçº¢è‰²è¡¨ç¤ºå®ä»»åŠ¡ï¼Œç»¿è‰²è¡¨ç¤ºå¾®ä»»åŠ¡
    
*   `å¾®1-`è¡¨ç¤ºç¬¬ä¸€æ¬¡è½®è¯¢ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼Œ`å¾®2-`è¡¨ç¤ºç¬¬äºŒæ¬¡ï¼Œä»¥æ­¤ç±»æ¨
    

#### ç¬¬ä¸€æ¬¡è½®è¯¢

script æ ‡ç­¾ (å® 0) æ‰§è¡Œ

è¾“å‡ºåŒæ­¥ä»£ç ï¼š

```
scriptÂ startÂ ->Â async1Â startÂ ->Â error1Â ->Â async2Â ->Â promise1Â ->Â scriptÂ end
```

æŒ‚è½½å¼‚æ­¥ä»»åŠ¡:

```
-()Â =>Â {Â //Â å®2-Â Â console.log('setTimeout');-}-()Â =>Â {Â //Â å®3-Â Â resolve('promise4')-}-()Â =>Â {Â //Â å®4-Â Â resolve(2)-}+()Â =>Â {Â //Â å¾®1-1+Â Â console.log('promise2');+Â Â returnÂ newÂ Promise((resolve)Â =>Â {+Â Â resolve()+}
```

åŒæ­¥ä»£ç å®Œæ¯•çš„åŒæ—¶ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ä¹Ÿæ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```
å¾®1-1:Â promise2Â ->Â å¾®1-2:Â thenÂ 1-1Â ->Â å¾®1-3:Â promise3
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```
+()Â =>Â {Â //Â å¾®1-2+Â Â console.log('thenÂ 1-1')+}+()Â =>Â {Â //Â å¾®1-3+Â Â console.log('promise3');+}
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

**æ³¨ 1**

> è¿™é‡Œå¾—è¯´ä¸€ä¸‹ï¼Œå¾ˆå¤šäººè®¤ä¸º await å°†ä»£ç åŒæ­¥åŒ–çš„æ„æ€ï¼Œå…¶å® await æ˜¯ Promise çš„è¯­æ³•ç³–ï¼Œå†…éƒ¨çš„å®ç°ä¹Ÿæ˜¯ä¾é  Promise, å…¶è¯ç”Ÿä¹Ÿå°±æ˜¯ä¸ºäº†ä¼˜åŒ– promise çš„ then é“¾å†™æ³•ï¼Œç”¨åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œè®©ä»£ç çœ‹èµ·æ¥æ›´ç®€æ´æ˜äº† await çš„çœŸå®æ„æ€æ˜¯ async wait(å¼‚æ­¥ç­‰å¾…çš„æ„æ€)await è¡¨è¾¾å¼ç›¸å½“äºè°ƒç”¨åé¢è¿”å› promise çš„ then æ–¹æ³•ï¼Œå¼‚æ­¥ï¼ˆç­‰å¾…ï¼‰è·å–å…¶è¿”å›å€¼ã€‚å³ await<==>promise.then
> 
> è¿™é‡Œçš„ async2 å‡½æ•°è¿”å›çš„ Promise ä¸­å¼€å¯äº†ä¸€ä¸ªå®ä»»åŠ¡ï¼Œawait å¼‚æ­¥ç­‰å¾…éœ€è¦ç­‰å¾…å®ä»»åŠ¡æ‰§è¡Œæ‰èƒ½è·å–å…¶è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´å®ä»»åŠ¡ä¸æ‰§è¡Œ await è¡¨è¾¾å¼å°±å‹æ ¹ä¸èƒ½è°ƒç”¨ Promise çš„ then æ–¹æ³•

**æ³¨ 2**

> å‰é¢è¯´è¿‡ await è¡¨è¾¾å¼åé¢çš„ä»£ç å¯ä»¥ç®€å•ç†è§£ä¸ºæ”¾å…¥åˆ°å¾®ä»»åŠ¡ä¸­ï¼Œä½†æ˜¯å‰é¢ await è¡¨è¾¾å¼å‹æ ¹å°±æ²¡æœ‰è·å–å¼‚æ­¥ç­‰å¾…çš„ç»“æœè¿™åé¢çš„ä»£ç ä»è·³å‡ºå½“å‰æ‰§è¡Œæ ˆåå°±å‹æ ¹æ²¡æœ‰æŒ‚è½½åˆ°å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œæœ‰äº›æ•™ç¨‹è¯´çš„ await è¡¨è¾¾å¼åé¢çš„ä»£ç å¯ä»¥çœ‹æˆå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªè¿™ç§è¯´æ³•æ˜¯é”™è¯¯çš„ï¼

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```
scriptÂ startÂ ->Â async1Â startÂ ->Â error1Â ->Â async2Â ->Â promise1Â ->Â scriptÂ endå¾®1-1:Â promise2Â ->Â å¾®1-2:Â thenÂ 1-1Â ->Â å¾®1-3:Â promise3
```

#### ç¬¬äºŒæ¬¡è½®è¯¢

ä¸Šé¢ç¬¬ä¸€æ³¢è½®è¯¢ç»“æŸï¼Œå¼€å¯ç¬¬äºŒæ³¢è½®è¯¢

æ‰§è¡Œç¬¬äºŒä¸ªå®ä»»åŠ¡é˜Ÿåˆ— (å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```
å®2ï¼šsetTimeout
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ²¡æœ‰äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡ã€‚ç¬¬äºŒæ¬¡è½®è¯¢ç»“æŸ

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```
å®2ï¼šsetTimeout
```

#### ç¬¬ä¸‰æ¬¡è½®è¯¢

æ‰§è¡Œç¬¬ä¸‰ä¸ªå®ä»»åŠ¡é˜Ÿåˆ— (å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```
å®ä»»åŠ¡æœ¬èº«æ²¡æœ‰è¾“å‡ºå•¥ï¼Œä¸è¿‡ç¡®å®šäº†ä¸‹Promiseçš„çŠ¶æ€å¹¶ä¼ é€’äº†ä¸ª'promise4'ç»™ä¸‹ä¸€ä¸ªthenä¸­çš„æˆåŠŸå›è°ƒ
```

å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—:

```
+(res)Â =>Â {Â //Â å¾®3-1+Â Â console.log(res);+}
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```
å¾®3-1:Â promise4Â ->Â å¾®3-2:Â undefined
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```
+resÂ =>Â {Â //Â å¾®3-2Â //Â TODOæ³¨3+Â Â console.log(res);+}
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```
å¾®3-1:Â promise4Â ->Â å¾®3-2:Â undefined
```

**æ³¨ 3**

> å‰é¢è¯´è¿‡ promise.finally() ä¹Ÿæ˜¯å¾®ä»»åŠ¡ï¼Œfinally å¯ä»¥ç†è§£ä¸ºä¸ç®¡ promise çš„çŠ¶æ€æ˜¯æˆåŠŸæˆ–å¤±è´¥éƒ½è¦æ‰§è¡Œæˆ‘ã€‚ä½†æ˜¯æˆ‘ä¸æ¥å—ä»»ä½•ç»“æœã€‚å› æ­¤ finally æ¥å—ä¸åˆ°è¿”å›å€¼ res ä¸º undefined

#### ç¬¬å››æ¬¡è½®è¯¢

æ‰§è¡Œç¬¬å››ä¸ªå®ä»»åŠ¡é˜Ÿåˆ— (å®ä»»åŠ¡é˜Ÿåˆ—åªå­˜æ”¾ä¸€ä¸ªå®ä»»åŠ¡)ï¼š

```
å®ä»»åŠ¡æœ¬èº«æ²¡æœ‰è¾“å‡ºå•¥ï¼Œä¸è¿‡ç¡®å®šäº†ä¸‹Promiseçš„çŠ¶æ€å¹¶ä¼ é€’äº†ä¸ª2ç»™ä¸‹ä¸€ä¸ªthenä¸­çš„æˆåŠŸå›è°ƒ
```

å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—:

ä¸Šé¢è¯´è¿‡ await => Promise.then(), ä¸Šé¢å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ç¡®å®šäº† promise çŠ¶æ€å¯ä»¥å»è·å–å¼‚æ­¥ç­‰å¾…çš„ç»“æœã€‚ç›¸å½“äºè¿™æ ·ï¼šPromise.then((res) => {return res}) è€Œ await è¡¨è¾¾å¼åé¢çš„ä»£ç ç›¸å½“äºåœ¨**å¼‚æ­¥ç­‰å¾…è·å–ç»“æœå**æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ç›¸å½“äºè¿™æ ·ï¼šPromise.then((res) => {return res}).finally(() => {}), åªæœ‰åœ¨ await è¡¨è¾¾å¼å‰é¢è·å–åˆ°ç»“æœåæ‰ä¼šåœ¨ä»£ç æŒ‚åœ¨åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­

å¯ä»¥åšä¸ªå®éªŒå°†ä¸Šé¢å¼‚æ­¥ç­‰å¾…å®šæ—¶å™¨çš„å€¼è®¾å®šä¸ºæ›´é•¿æ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™ await è¡¨è¾¾å¼åé¢çš„ä»£ç æ˜¯ä¸ä¸ºå“åº”çš„ï¼Œåªæœ‰è·å–åˆ°äº†å¼‚æ­¥ç­‰å¾…çš„ç»“æœï¼Œæ‰ä¼šå“åº”ã€‚

```
+(res)Â =>Â {returnÂ res}Â //Â å¾®4-1+()Â =>Â {async1Â end}Â //Â å¾®4-2
```

å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¼€å§‹æ¸…ç©ºå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š

```
å¾®4-1:Â 2Â ->Â å¾®4-2:Â async1Â end
```

æ‰§è¡Œå¾®ä»»åŠ¡ä¸­æ‰€äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡, æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¯¥å¾®ä»»åŠ¡ä¹Ÿä¼šåœ¨æ­¤æ¬¡è½®è¯¢ä¸­è¢«æ¸…ç©º:

```
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡
```

æ‰§è¡Œå¾®ä»»åŠ¡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„å®ä»»åŠ¡æ”¾åˆ°æ–°å®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼š

```
æœ¬æ¬¡å¾®ä»»åŠ¡æ‰§è¡Œæ²¡æœ‰äº§ç”Ÿæ–°çš„å®ä»»åŠ¡
```

æ­¤æ¬¡è½®è¯¢ç»“æŸè¾“å‡ºç»“æœæœ‰ï¼š

```
å¾®4-1:Â 2Â ->Â å¾®4-2:Â async1Â end
```

#### æ‰€æœ‰è½®è¯¢å®Œæ¯•ä¹‹åçš„å®Œæ•´ç»“æœ

```
scriptÂ startÂ ->Â async1Â startÂ ->Â error1Â ->Â async2Â ->Â promise1Â ->Â scriptÂ endå¾®1-1:Â promise2Â ->Â å¾®1-2:Â thenÂ 1-1Â ->Â å¾®1-3:Â promise3å®2ï¼šsetTimeoutå¾®3-1:Â promise4Â ->Â å¾®3-2:Â undefinedå¾®4-1:Â 2Â ->Â å¾®4-2:Â async1Â end
```

å¦‚æœä½ å››é“é¢˜å…¨å¯¹çš„è¯ï¼Œé‚£ä¹ˆæ­å–œä½ ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/j3vcKBBdH45RNOM0sYAw5Z625dLlcsBvAia9GrRAmN3r0601KMlbJmECSibkNKaDUBvMiclK3QNbZWxrB0ianHtEWA/640?wx_fmt=png)

å†™åœ¨æœ€å
====

å¯¹äºã€å‰ç«¯ä½“ç³»ã€‘è¿™ç³»åˆ—çš„æ–‡ç« æˆ‘æ˜¯æŠ±ç€å¾ˆè®¤çœŸï¼Œå¾ˆæƒ³å†™å¥½çš„å¿ƒæ€çš„ï¼Œä½†æ¯•ç«Ÿæˆ‘è¿˜æ˜¯å‰ç«¯å°ç™½ & å†™ä½œæ–°äººï¼Œå¦‚æœæ–‡ç« ä¸­æœ‰é‚£å—å†™çš„ä¸å¤ªå¥½æˆ–æœ‰é—®é¢˜æ¬¢è¿å¤§å®¶æŒ‡å‡ºï¼Œæˆ‘ä¹Ÿä¼šåœ¨åé¢çš„æ–‡ç« ä¸åœä¿®æ”¹ã€‚ä¹Ÿå¸Œæœ›è‡ªå·±è¿›æ­¥çš„åŒæ—¶èƒ½è·Ÿä½ ä»¬ä¸€èµ·æˆé•¿ã€‚å–œæ¬¢æˆ‘æ–‡ç« çš„æœ‹å‹ä»¬ä¹Ÿå¯ä»¥å…³æ³¨ä¸€ä¸‹

æˆ‘ä¼šå¾ˆæ„Ÿæ¿€ç¬¬ä¸€æ‰¹å…³æ³¨æˆ‘çš„äººã€‚**æ­¤æ—¶ï¼Œå¹´è½»çš„æˆ‘å’Œä½ ï¼Œè½»è£…ä¸Šé˜µï¼›è€Œåï¼Œå¯Œè£•çš„ä½ å’Œæˆ‘ï¼Œæ»¡è½½è€Œå½’ã€‚**

ç³»åˆ—æ–‡ç« 
----

ã€å‰ç«¯ä½“ç³»ã€‘ä»åœ°åŸºå¼€å§‹æ‰“é€ ä¸€åº§ä¸‡ä¸ˆé«˜æ¥¼ [8]

å‚è€ƒæ–‡ç« 
----

æ·±å…¥ç†è§£ JavaScript Event Loop[9]

### å‚è€ƒèµ„æ–™

[1]

Processing model: _https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model_

[2]

æ­£åœ¨è¿è¡Œçš„ task: _https://html.spec.whatwg.org/multipage/webappapis.html#currently-running-task_

[3]

currently running task: _https://html.spec.whatwg.org/multipage/webappapis.html#currently-running-task_

[4]

microtasks ä»»åŠ¡æ£€æŸ¥ç‚¹: _https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint_

[5]

WorkerGlobalScope: _https://html.spec.whatwg.org/multipage/workers.html#workerglobalscope_

[6]

Web workers: _https://html.spec.whatwg.org/multipage/workers.html#workers_

[7]

run a worker: _https://html.spec.whatwg.org/multipage/workers.html#run-a-worker_

[8]

ã€å‰ç«¯ä½“ç³»ã€‘ä»åœ°åŸºå¼€å§‹æ‰“é€ ä¸€åº§ä¸‡ä¸ˆé«˜æ¥¼: _https://juejin.im/post/6867784542338416648#comment_

[9]

æ·±å…¥ç†è§£ JavaScript Event Loop: _https://zhuanlan.zhihu.com/p/34229323_

äº¤æµè®¨è®º
----

```
æ¬¢è¿å…³æ³¨ã€Œå‰ç«¯ç“¶å­å›ã€ï¼Œå›å¤ã€Œäº¤æµã€åŠ å…¥å‰ç«¯äº¤æµç¾¤ï¼
å›å¤ã€Œç®—æ³•ã€ï¼Œä½ å¯ä»¥æ¯å¤©å­¦ä¹ ä¸€é“å¤§å‚ç®—æ³•ç¼–ç¨‹é¢˜ï¼ˆé˜¿é‡Œã€è…¾è®¯ã€ç™¾åº¦ã€å­—èŠ‚ç­‰ç­‰ï¼‰æˆ– leetcodeï¼Œç“¶å­å›éƒ½ä¼šåœ¨ç¬¬äºŒå¤©è§£ç­”å“Ÿï¼
å¦å¤–ï¼Œæ¯å‘¨è¿˜æœ‰æ‰‹å†™æºç é¢˜ï¼Œç“¶å­å›ä¹Ÿä¼šè§£ç­”å“Ÿï¼
ã€‹ã€‹é¢è¯•å®˜ä¹Ÿåœ¨çœ‹çš„ç®—æ³•èµ„æ–™ã€Šã€Š
â€œåœ¨çœ‹å’Œè½¬å‘â€å°±æ˜¯æœ€å¤§çš„æ”¯æŒ

```