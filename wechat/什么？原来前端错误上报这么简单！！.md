> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-5h-ibshx8s0nF-VkLIANw)

```
å¤§å‚æŠ€æœ¯Â Â é«˜çº§å‰ç«¯Â Â Nodeè¿›é˜¶

ç‚¹å‡»ä¸Šæ–¹Â ç¨‹åºå‘˜æˆé•¿æŒ‡åŒ—ï¼Œå…³æ³¨å…¬ä¼—å·

å›å¤1ï¼ŒåŠ å…¥é«˜çº§Nodeäº¤æµç¾¤

```

å‰è¨€
==

é¡¹ç›®ä¸Šçº¿ä¹‹åï¼Œç”¨æˆ·å¦‚æœå‡ºç°é”™è¯¯ï¼ˆä»£ç æŠ¥é”™ã€èµ„æºåŠ è½½å¤±è´¥ä»¥åŠå…¶ä»–æƒ…å†µï¼‰ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰åŠæ³•å¤ç°ï¼Œå¦‚æœç”¨æˆ·å‡ºäº†é—®é¢˜ä½†æ˜¯ä¸åé¦ˆæˆ–ç›´æ¥ä¸ç”¨äº†ï¼Œå¯¹å¼€å‘è€…æˆ–å…¬å¸æ¥è¯´éƒ½æ˜¯æŸå¤±ã€‚

ç”±äºæˆ‘è¿™ä¸ªé¡¹ç›®æ¯”è¾ƒå°ï¼Œåªæ˜¯ä¸€ä¸ªè¿·ä½ å•†åŸï¼Œæ‰€ä»¥ä¸éœ€è¦æ”¶é›†å¾ˆå¤æ‚çš„æ•°æ®ï¼Œåªéœ€è¦çŸ¥é“æœ‰æ²¡æœ‰èµ„æºåŠ è½½å¤±è´¥ã€å“ªè¡Œä»£ç æŠ¥é”™å°±å¯ä»¥äº†ï¼Œå¸‚é¢ä¸Šæœ‰å¾ˆå¤šç°æˆçš„ç›‘æ§å¹³å°æ¯”å¦‚ sentryï¼Œåœ¨è¿™é‡Œæˆ‘é€‰æ‹©é€šè¿‡ nodejs è‡ªå·±æ­ä¸€ä¸ªæœåŠ¡ã€‚

æ¦‚è¿°
==

æˆ‘çš„é¡¹ç›®æ˜¯ä½¿ç”¨ Vue2 å†™çš„ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦æ˜¯è®² Vue ç›¸å…³çš„éƒ¨ç½²è¿‡ç¨‹

1ã€éƒ¨ç½²åå°æœåŠ¡ï¼ˆä½¿ç”¨ expressï¼‰

2ã€æ”¶é›†å‰ç«¯é”™è¯¯ï¼ˆä¸»è¦æ˜¯ Vueï¼‰

3ã€æäº¤ä¿¡æ¯åˆ°åå°åˆ†ææºç ä½ç½®åŠè®°å½•æ—¥å¿—

js å¼‚å¸¸å¤„ç†
=======

```
functionÂ test1Â ()Â {
Â Â Â Â console.log('test1Â Start');
Â Â Â Â console.log(a);
Â Â Â Â console.log('test1Â End');
}

functionÂ test2Â ()Â {
Â Â Â Â console.log('test2Â Start');
Â Â Â Â console.log('test2Â End');
}

test1();
test2();


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljB2XXBTZLgChTstcTiaI2M4arzjMocbQkNfscLvtIzKfv1puyFQs2tjg/640?wx_fmt=other&from=appmsg)

è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå½“ js è¿è¡ŒæŠ¥é”™åï¼Œä»£ç å°±ä¸å¾€ä¸‹æ‰§è¡Œäº†ï¼Œè¿™æ˜¯å› ä¸º js æ˜¯å•çº¿ç¨‹ï¼Œå…·ä½“å¯ä»¥çœ‹çœ‹äº‹ä»¶å¾ªç¯ï¼Œè¿™é‡Œä¸åšè§£é‡Š

æ¥ä¸‹æ¥çœ‹çœ‹ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰å½±å“ä»£ç çš„ç»§ç»­è¿è¡Œ

```
functionÂ test1Â ()Â {
Â Â Â Â console.log('test1Â Start');
Â Â Â Â console.log(a);
Â Â Â Â console.log('test1Â End')
}

functionÂ test2Â ()Â {
Â Â Â Â console.log('test2Â Start');
Â Â Â Â console.log('test2Â End')
}

setTimeout(()Â =>Â {
Â Â Â Â test1();
},Â 0)

setTimeout(()Â =>Â {
Â Â Â Â test2();
},Â 0)


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljkKoeMxvKxMRI2Ad7VLoFPkSthicOoJiaINysibWMOYB8l7n366iaRetdRw/640?wx_fmt=other&from=appmsg)  

é‚£æŠ¥é”™ä¹‹åæˆ‘ä»¬å¦‚ä½•æ”¶é›†é”™è¯¯å‘¢ï¼Ÿ

try catch
---------

```
functionÂ test1Â ()Â {
Â Â Â Â console.log('test1Â Start');
Â Â Â Â console.log(a);
Â Â Â Â console.log('test1Â End')
}

tryÂ {
Â Â test1();
}Â catchÂ (e)Â {
Â Â console.log(e);
}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljCtaZHt9HvazlfsyMK01ibkYTlz8KGWSvLUOaYTl12xEVnMFxdfdicJibQ/640?wx_fmt=other&from=appmsg)

ä½¿ç”¨`try catch`å°†ä»£ç åŒ…è£¹èµ·æ¥ä¹‹åï¼Œå½“è¿è¡ŒæŠ¥é”™æ—¶ï¼Œä¼šå°†æ”¶é›†åˆ°çš„é”™è¯¯ä¼ åˆ° catch çš„å½¢å‚ä¸­ï¼Œæ‰“å°ä¹‹åæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°é”™è¯¯ä¿¡æ¯å’Œé”™è¯¯çš„å †æ ˆä¿¡æ¯ï¼Œä½†æ˜¯`try catch`æ— æ³•æ•è·åˆ°å¼‚æ­¥çš„é”™è¯¯

```
functionÂ test1Â ()Â {
Â Â Â Â console.log('test1Â Start');
Â Â Â Â console.log(a);
Â Â Â Â console.log('test1Â End')
}

tryÂ {
Â Â setTimeout(function()Â {
Â Â Â Â test1();
Â Â },Â 100);
}Â catchÂ (e)Â {
Â Â console.log(e);
}


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4lj5Mbvj1Irr3re5Qrwz16YN2HEeFnIx0a7DjkSEfgvqTug4QicUX5UjWA/640?wx_fmt=other&from=appmsg)

å¯ä»¥çœ‹åˆ°`try catch`æ˜¯æ— æ³•æ•è·åˆ°å¼‚æ­¥é”™è¯¯çš„ï¼Œè¿™æ—¶å€™å°±è¦ç”¨åˆ°`window`çš„`error`äº‹ä»¶

ç›‘å¬ error äº‹ä»¶
-----------

```
window.addEventListener('error',Â argsÂ =>Â {
Â Â console.log(args);
Â Â returnÂ true;
},Â true)

functionÂ test1Â ()Â {
Â Â Â Â console.log('test1Â Start');
Â Â Â Â console.log(a);
Â Â Â Â console.log('test1Â End')
}

setTimeout(function()Â {
Â Â test1();
},Â 100);


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljEaecEITYgwHU7sn4MNdqGRb03xEYL6YbfjEUFkicpbJomyQUIWDb8TA/640?wx_fmt=other&from=appmsg)

é™¤äº†`window.addEventListener`å¯ä»¥ç›‘å¬`error`ä¹‹åï¼Œ`window.onerror`ä¹Ÿå¯ä»¥ç›‘å¬`error`ï¼Œä½†æ˜¯`window.onerror`å’Œ`window.addEventListener`ç›¸æ¯”ï¼Œæ— æ³•ç›‘å¬ç½‘ç»œå¼‚å¸¸

### window.addEventListener

```
<imgÂ src="https://www.baidu.com/abcdefg.gif">
<script>
Â Â window.addEventListener('error',Â argsÂ =>Â {
Â Â Â Â console.log(args);
Â Â Â Â returnÂ true;
Â Â },Â true)Â //Â æ•è·
</script>


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljWOuQmlAsYqSPLNodOkgic1RWIkvtu1NwAicmhaddUxCBKGE004oqgJeA/640?wx_fmt=other&from=appmsg)

### window.onerror

```
<imgÂ src="https://www.baidu.com/abcdefg.gif">
<script>
Â Â window.onerrorÂ =Â function(...args)Â {
Â Â Â Â console.log(args);
Â Â }
</script>


```

ç”±äºæ— æ³•ç›‘å¬åˆ°ï¼Œè¿™é‡Œå°±ä¸æ”¾å›¾äº†

unhandledrejection
------------------

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ`Promise`å·²ç»æˆä¸ºäº†å¼€å‘è€…çš„æ ‡é…ï¼ŒåŠ ä¸Šæ–°ç‰¹æ€§å¼•å…¥äº†`async await`ï¼Œè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½†`window.onerror`å’Œ`window.addEventListener`ï¼Œå¯¹`Promise`æŠ¥é”™éƒ½æ˜¯æ— æ³•æ•è·

```
window.addEventListener('error',Â errorÂ =>Â {
Â Â console.log('window',Â error);
})
newÂ Promise((resolve,Â reject)Â =>Â {
Â Â console.log(a);
}).catch(errorÂ =>Â {
Â Â console.log('catch',Â error);
})


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljZd0wc4EALXp410gHDmJf3C8CkgBannP9Q1iaM5Dyk25r7yyiaJZZIibow/640?wx_fmt=other&from=appmsg)

  

å¯ä»¥çœ‹åˆ°ï¼Œç›‘å¬`window`ä¸Šçš„`error`äº‹ä»¶æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå¯ä»¥æ¯ä¸€ä¸ª`Promise`å†™ä¸€ä¸ª`catch`ï¼Œå¦‚æœè§‰å¾—éº»çƒ¦ï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨ä¸€ä¸ªæ–°çš„äº‹ä»¶ï¼Œ`unhandledrejection`

```
window.addEventListener('unhandledrejection',Â errorÂ =>Â {
Â Â console.log('window',Â error);
})
newÂ Promise((resolve,Â reject)Â =>Â {
Â Â console.log(a);
})


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljibZgbXcyiaMqaa1Y95vdib9D8n4cnibrmrTFo6pkiclGHZwxr1nmZSge1ow/640?wx_fmt=other&from=appmsg)

å…¶ä¸­ï¼Œ`reason`ä¸­å­˜æ”¾ç€é”™è¯¯ç›¸å…³ä¿¡æ¯ï¼Œ`reason.message`æ˜¯é”™è¯¯ä¿¡æ¯ï¼Œ`reason.stack`æ˜¯é”™è¯¯å †æ ˆä¿¡æ¯

Promise é”™è¯¯ä¹Ÿå¯ä»¥ä½¿ç”¨ try catch æ•è·åˆ°ï¼Œè¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†

è‡³æ­¤ï¼Œjs ä¸­`åŒæ­¥`ã€`å¼‚æ­¥`ã€`èµ„æºåŠ è½½`ã€`Promise`ã€`async/await`éƒ½æœ‰ç›¸å¯¹åº”çš„æ•è·æ–¹å¼

```
window.addEventListener('unhandledrejection',Â errorÂ =>Â {
Â Â console.log('window',Â error);
Â Â throwÂ error.reason;
})

window.addEventListener('error',Â errorÂ =>Â {
Â Â console.log(error);
Â Â returnÂ true;
},Â true)


```

vue å¼‚å¸¸å¤„ç†
========

ç”±äºæˆ‘çš„é¡¹ç›®ä½¿ç”¨ Vue2 æ­å»ºçš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¤„ç†ä¸€ä¸‹ vue çš„æŠ¥é”™

```
exportÂ defaultÂ {
Â Â name:Â 'App',
Â Â mounted()Â {
Â Â Â Â console.log(aaa);
Â Â }
}


```

ç°åœ¨çš„é¡¹ç›®åŸºæœ¬ä¸Šéƒ½æ˜¯å·¥ç¨‹åŒ–çš„ï¼Œé€šè¿‡å·¥ç¨‹åŒ–å·¥å…·æ‰“åŒ…å‡ºæ¥çš„ä»£ç é•¿è¿™æ ·ï¼Œä¸Šé¢çš„ä»£ç æ‰“åŒ…åè¿è¡Œ![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4lj4TJOjaNodqhc1kUEYhEFH4CLBlMQTibY1FdhhvkB4QSqy5Bt6v6VJbw/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4lj5rQ4nSrswZowxEduexnpBS6pKlonDGUxVn1hqcvCq2KzSITAfCiaCbQ/640?wx_fmt=other&from=appmsg)

é€šè¿‡æŠ¥é”™æç¤ºçš„ js æ–‡ä»¶ï¼ŒæŸ¥çœ‹åéƒ½æ˜¯å‹ç¼©æ··æ·†ä¹‹åçš„ js ä»£ç ï¼Œè¿™æ—¶å€™å°±éœ€è¦æ‰“åŒ…æ—¶ç”Ÿæˆçš„`source map`æ–‡ä»¶äº†ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­ä¿å­˜ç€æ‰“åŒ…åä»£ç å’Œæºç å¯¹åº”çš„ä½ç½®ï¼Œæˆ‘ä»¬åªéœ€è¦æ‹¿åˆ°æŠ¥é”™çš„å †æ ˆä¿¡æ¯ï¼Œé€šè¿‡è½¬æ¢ï¼Œå°±èƒ½é€šè¿‡`source map`æ‰¾åˆ°å¯¹åº”æˆ‘ä»¬æºç çš„æ–‡ä»¶åŠå‡ºé”™çš„ä»£ç è¡Œåˆ—ä¿¡æ¯

é‚£æˆ‘ä»¬æ€ä¹ˆæ‰èƒ½ç›‘å¬`error`äº‹ä»¶å‘¢ï¼Ÿ

ä½¿ç”¨ Vue çš„å…¨å±€é”™è¯¯å¤„ç†å‡½æ•°`Vue.config.errorHandler`

åœ¨`src/main.js`ä¸­å†™å…¥ä»¥ä¸‹ä»£ç 

```
Vue.config.errorHandlerÂ =Â (err,Â vm,Â info)Â =>Â {
Â Â console.log('Error:Â ',Â err);
Â Â console.log('vm',Â vm);
Â Â console.log('info:Â ',Â info);
}


```

ç°åœ¨æ‰“åŒ… vue é¡¹ç›®

æ‰“åŒ… vue ä¹‹åç„¶åé€šè¿‡ç«¯å£è®¿é—®`index.html`ï¼Œä¸å»ºè®®ä½ åŒå‡»æ‰“å¼€ï¼Œå¦‚æœä½ æ²¡æ”¹è¿‡æ‰“åŒ…ç›¸å…³çš„ä¸œè¥¿ï¼ŒåŒå‡»æ‰“å¼€æ˜¯ä¸è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡`vs code`è£…æ’ä»¶`live server`ï¼Œç„¶åå°†æ‰“åŒ…æ–‡ä»¶å¤¹é€šè¿‡`vs code`æ‰“å¼€

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljD6TeO7mDQhkTmEmgSQrLgrgU21iclwvnwBpxtEQXiaCSkzORNYusgxDA/640?wx_fmt=other&from=appmsg)

ä¸ŠæŠ¥é”™è¯¯æ•°æ®
======

ç»è¿‡ä¸Šè¿°çš„å¼‚å¸¸å¤„ç†åï¼Œæˆ‘ä»¬éœ€è¦å°†æ”¶é›†åˆ°çš„é”™è¯¯è¿›è¡Œæ•´ç†ï¼Œå°†éœ€è¦çš„ä¿¡æ¯å‘é€åˆ°åå°ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨ ajax å‘è¯·æ±‚åˆ°åç«¯ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ›å»ºä¸€ä¸ªå›¾ç‰‡æ ‡ç­¾ï¼Œå°†éœ€è¦å‘é€çš„æ•°æ®æ‹¼æ¥åˆ° src ä¸Š

è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨`tracekit`åº“æ¥è§£æé”™è¯¯çš„å †æ ˆä¿¡æ¯ï¼Œ`axios`å‘è¯·æ±‚ï¼Œ`dayjs`æ ¼å¼åŒ–æ—¶é—´

```
npmÂ iÂ tracekit
npmÂ iÂ axios
npmÂ iÂ dayjs


```

å®‰è£…å®Œæˆååœ¨`src/main.js`ä¸­å¼•å…¥`tracekit`ã€`axios`ã€`dayjs`

ä¸ŠæŠ¥ Vue é”™è¯¯
---------

```
importÂ TraceKitÂ fromÂ 'tracekit';
importÂ axiosÂ fromÂ 'axios';
importÂ dayjsÂ fromÂ 'dayjs';

constÂ protcolÂ =Â window.location.protocol;
letÂ errorMonitorUrlÂ =Â `${protcol}//127.0.0.1:9999`;
constÂ errorMonitorVueInterFaceÂ =Â 'reportVueError';Â //Â vueé”™è¯¯ä¸ŠæŠ¥æ¥å£
TraceKit.report.subscribe((error)Â =>Â {
Â Â constÂ {Â message,Â stackÂ }Â =Â errorÂ ||Â {};

Â Â constÂ objÂ =Â {
Â Â Â Â message,
Â Â Â Â stack:Â {
Â Â Â Â Â Â column:Â stack[0].column,
Â Â Â Â Â Â line:Â stack[0].line,
Â Â Â Â Â Â func:Â stack[0].func,
Â Â Â Â Â Â url:Â stack[0].url
Â Â Â Â }
Â Â };

Â Â axios({
Â Â Â Â method:Â 'POST',
Â Â Â Â url:Â `${errorMonitorUrl}/${errorMonitorVueInterFace}`,
Â Â Â Â data:Â {
Â Â Â Â Â Â error:Â obj,
Â Â Â Â Â Â data:Â {
Â Â Â Â Â Â Â Â errTime:Â dayjs().format('YYYY-MM-DDÂ HH:mm:ss'),
Â Â Â Â Â Â Â Â isMobile:Â /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),Â //Â æ˜¯å¦ç§»åŠ¨ç«¯
Â Â Â Â Â Â Â Â isWechat:Â /MicroMessenger/i.test(navigator.userAgent),Â //Â æ˜¯å¦å¾®ä¿¡æµè§ˆå™¨
Â Â Â Â Â Â Â Â isIOS:Â /iPad|iPhone|iPod/.test(navigator.userAgent)Â &&Â !window.MSStream,Â //Â ä¸¤ä¸ªéƒ½æ˜¯falseå°±æ˜¯æœªçŸ¥è®¾å¤‡
Â Â Â Â Â Â Â Â isAndroid:Â /Android/.test(navigator.userAgent)Â &&Â !/WindowsÂ Phone/.test(navigator.userAgent)
Â Â Â Â Â Â },
Â Â Â Â Â Â browserInfo:Â {
Â Â Â Â Â Â Â Â userAgent:Â navigator.userAgent,
Â Â Â Â Â Â Â Â protcol:Â protcol
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }).then(()Â =>Â {
Â Â Â Â console.log('é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ');
Â Â }).catch(()Â =>Â {
Â Â Â Â console.log('é”™è¯¯ä¸ŠæŠ¥å¤±è´¥');
Â Â });
});

Vue.config.errorHandlerÂ =Â (err,Â vm,Â info)Â =>Â {
Â Â TraceKit.report(err);
}


```

å¦‚æœä½ è¿˜éœ€è¦å…¶ä»–çš„æ•°æ®å°±è‡ªå·±åŠ 

æ‰“åŒ… vue ä¹‹åç„¶åé€šè¿‡ç«¯å£è®¿é—®`index.html`ï¼Œä¸å»ºè®®ä½ åŒå‡»æ‰“å¼€ï¼Œå¦‚æœä½ æ²¡æ”¹è¿‡æ‰“åŒ…ç›¸å…³çš„ä¸œè¥¿ï¼ŒåŒå‡»æ‰“å¼€æ˜¯ä¸è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡`vs code`è£…æ’ä»¶`live server`ï¼Œç„¶åå°†æ‰“åŒ…æ–‡ä»¶å¤¹é€šè¿‡`vs code`æ‰“å¼€

ç°åœ¨å»é¡¹ç›®ä¸­çœ‹çœ‹å‘å‡ºå»çš„è¯·æ±‚å‚æ•°æ˜¯ä»€ä¹ˆ

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®éƒ½å·²ç»æ”¶é›†åˆ°äº†ï¼Œä¸ŠæŠ¥å¤±è´¥æ˜¯è‚¯å®šçš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å†™å¥½æ¥å£

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljC1Oym9FT2TuXR8azic2IdibYwp82KBnGIO8zT3UJdeRFk2O6iagu2eyVA/640?wx_fmt=other&from=appmsg)

ä¸ŠæŠ¥ window é”™è¯¯
------------

æ¥ä¸‹æ¥åœ¨ç›‘å¬`window`çš„`error`äº‹ä»¶ï¼Œä¹Ÿå‘åå°å‘é€ä¸€ä¸ªé”™è¯¯ä¸ŠæŠ¥è¯·æ±‚

```
constÂ errorMonitorWindowInterFaceÂ =Â 'reportWindowError';Â //Â windowé”™è¯¯ä¸ŠæŠ¥æ¥å£
window.addEventListener('error',Â argsÂ =>Â {
Â Â constÂ errÂ =Â args.target.srcÂ ||Â args.target.href;
Â Â constÂ objÂ =Â {
Â Â Â Â message:Â 'åŠ è½½å¼‚å¸¸'Â +Â err
Â Â };
Â Â ifÂ (!err)Â {
Â Â Â Â returnÂ true;
Â Â }
Â Â axios({
Â Â Â Â method:Â 'POST',
Â Â Â Â url:Â `${errorMonitorUrl}/${errorMonitorWindowInterFace}`,
Â Â Â Â data:Â {
Â Â Â Â Â Â error:Â obj,
Â Â Â Â Â Â data:Â {
Â Â Â Â Â Â Â Â errTime:Â dayjs().format('YYYY-MM-DDÂ HH:mm:ss'),
Â Â Â Â Â Â Â Â isMobile:Â /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),Â //Â æ˜¯å¦ç§»åŠ¨ç«¯
Â Â Â Â Â Â Â Â isWechat:Â /MicroMessenger/i.test(navigator.userAgent),Â //Â æ˜¯å¦å¾®ä¿¡æµè§ˆå™¨
Â Â Â Â Â Â Â Â isIOS:Â /iPad|iPhone|iPod/.test(navigator.userAgent)Â &&Â !window.MSStream,Â //Â ä¸¤ä¸ªéƒ½æ˜¯falseå°±æ˜¯æœªçŸ¥è®¾å¤‡
Â Â Â Â Â Â Â Â isAndroid:Â /Android/.test(navigator.userAgent)Â &&Â !/WindowsÂ Phone/.test(navigator.userAgent)
Â Â Â Â Â Â },
Â Â Â Â Â Â browserInfo:Â {
Â Â Â Â Â Â Â Â userAgent:Â navigator.userAgent,
Â Â Â Â Â Â Â Â protcol:Â protcol
Â Â Â Â Â Â }
Â Â Â Â }
Â Â }).then(()Â =>Â {
Â Â Â Â console.log('é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ');
Â Â }).catch(()Â =>Â {
Â Â Â Â console.log('é”™è¯¯ä¸ŠæŠ¥å¤±è´¥');
Â Â });
Â Â returnÂ true;
},Â true);


```

æ­å»ºç›‘æ§åå°
======

åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—éšä¾¿ï¼Œç„¶ååœ¨ç»ˆç«¯ä¸­æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œåˆå§‹åŒ– npm

```
npmÂ initÂ -y


```

åˆå§‹åŒ–å®Œæˆååˆ›å»ºä¸€ä¸ª`server.js`ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨`express`è¿›è¡Œæ­å»ºåç«¯ï¼Œ`source-map`ç”¨äºè§£æ`js.map`æ–‡ä»¶ï¼Œè¿™äº›åº“åé¢ä¼šç”¨åˆ°

```
npmÂ iÂ express
npmÂ iÂ nodemon
npmÂ iÂ source-map


```

ä¸‹å¥½åŒ…ä¹‹ååœ¨`server.js`ä¸­è¾“å…¥ä»¥ä¸‹ä»£ç ï¼Œç„¶ååœ¨ç»ˆç«¯è¾“å…¥`nodemon server.js`

```
constÂ expressÂ =Â require('express');
constÂ pathÂ =Â require('path')ï¼›
constÂ fsÂ =Â require('fs');

constÂ PORTÂ =Â 9999;

constÂ appÂ =Â express();
app.use(express.urlencoded({Â extended:Â trueÂ }))ï¼›
app.use(express.json())ï¼›

app.get('/',Â (req,Â res)Â =>Â {
Â Â res.send('HelloÂ World!').status(200);
})

app.listen(PORT,Â ()Â =>Â {
Â Â console.log(`æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç«¯å£å·ä¸º:${PORT}`)
})


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljqOj1Roia6p7dUNT2UicSibxrt2VswOTzIEQCqYLS3ib8B963TK4vicdicSYQ/640?wx_fmt=other&from=appmsg)

  

æœåŠ¡å¯åŠ¨ä¹‹åï¼Œè®¿é—®æœ¬åœ°çš„ 9999 ç«¯å£ï¼ŒæŸ¥çœ‹æ˜¯å¦ç”Ÿæ•ˆï¼Œå½“çœ‹åˆ°å±å¹•ä¸Šæ˜¾ç¤º`Hello World!`è¡¨ç¤ºæˆ‘ä»¬çš„åç«¯æœåŠ¡æˆåŠŸè·‘èµ·æ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™é”™è¯¯çš„ä¸Šä¼ æ¥å£

åœ¨è¿™é‡Œæˆ‘å°†ä¸º Vue å’Œ Window ç›‘æ§åˆ†åˆ«å†™ä¸€ä¸ªæ¥å£ï¼ˆå› ä¸ºæˆ‘æ‡’å¾—ä¸€ä¸ªæ¥å£åšåˆ¤æ–­åŒºåˆ†ï¼Œå¦‚æœä½ è§‰å¾—ä¸¤ä¸ªæ¥å£å¤ªéº»çƒ¦ï¼Œé‚£ä½ ä¹Ÿå¯ä»¥è‡ªå·±ä¼˜åŒ–æˆä¸€ä¸ªæ¥å£ï¼‰

ç¼–å†™ Vue é”™è¯¯ä¸ŠæŠ¥æ¥å£
-------------

åœ¨`server.js`ä¸­ç»§ç»­æ·»åŠ 

```
constÂ SourceMapÂ =Â require('source-map');

app.post('/reportVueError',asyncÂ (req,Â res)Â =>Â {
Â Â constÂ urlParamsÂ =Â req.body;
Â Â console.log(`æ”¶åˆ°Vueé”™è¯¯æŠ¥å‘Š`);
Â Â console.log('urlParams',Â urlParams);

Â Â constÂ stackÂ =Â urlParams.error.stack;
Â Â //Â è·å–æ–‡ä»¶å
Â Â constÂ fileNameÂ =Â path.basename(stack.url);
Â Â //Â æŸ¥æ‰¾mapæ–‡ä»¶
Â Â constÂ filePathÂ =Â path.join(__dirname,Â 'uploads',Â fileNameÂ +Â '.map');
Â Â constÂ readFileÂ =Â functionÂ (filePath)Â {
Â Â Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {
Â Â Â Â Â Â fs.readFile(filePath,Â {Â encoding:Â 'utf-8'},Â (err,Â data)Â =>Â {
Â Â Â Â Â Â Â Â ifÂ (err)Â {
Â Â Â Â Â Â Â Â Â Â console.log('readFileErr',Â err)
Â Â Â Â Â Â Â Â Â Â returnÂ reject(err);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â resolve(JSON.parse(data));
Â Â Â Â Â Â })
Â Â Â Â })
Â Â }

Â Â asyncÂ functionÂ searchSource({Â filePath,Â line,Â columnÂ })Â {
Â Â Â Â constÂ rawSourceMapÂ =Â awaitÂ readFile(filePath);
Â Â Â Â constÂ consumerÂ =Â awaitÂ newÂ SourceMap.SourceMapConsumer(rawSourceMap);
Â Â Â Â constÂ resÂ =Â consumer.originalPositionFor({Â line,Â columnÂ })

Â Â Â Â consumer.destroy();
Â Â Â Â returnÂ res;
Â Â }

Â Â letÂ sourceMapParseResultÂ =Â '';
Â Â tryÂ {
Â Â Â Â //Â è§£æsourceMapç»“æœ
Â Â Â Â sourceMapParseResultÂ =Â awaitÂ searchSource({Â filePath,Â line:Â stack.line,Â column:Â stack.columnÂ });
Â Â }Â catchÂ (err)Â {
Â Â Â Â sourceMapParseResultÂ =Â err;
Â Â }
Â Â console.log('è§£æç»“æœ',Â sourceMapParseResult)
Â Â res.send({
Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ',
Â Â Â Â status:Â 200,
Â Â }).status(200);
})


```

ç„¶å`nodemon`ä¼šè‡ªåŠ¨é‡å¯æœåŠ¡ï¼Œå¦‚æœä½ ä¸æ˜¯ç”¨`nodemon`å¯åŠ¨çš„ï¼Œé‚£è‡ªå·±æ‰‹åŠ¨é‡å¯ä¸€ä¸‹

æ‰“åŒ… vue ä¹‹åç„¶åé€šè¿‡ç«¯å£è®¿é—®`index.html`ï¼Œä¸å»ºè®®ä½ åŒå‡»æ‰“å¼€ï¼Œå¦‚æœä½ æ²¡æ”¹è¿‡æ‰“åŒ…ç›¸å…³çš„ä¸œè¥¿ï¼ŒåŒå‡»æ‰“å¼€æ˜¯ä¸è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡`vs code`è£…æ’ä»¶`live server`ï¼Œç„¶åå°†æ‰“åŒ…æ–‡ä»¶å¤¹é€šè¿‡`vs code`æ‰“å¼€ï¼Œé€šè¿‡`live server`è¿è¡Œï¼Œæ­¤æ—¶åº”è¯¥ä¼šæŠ¥è·¨åŸŸé—®é¢˜

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljV8oZd7ZReLgMeMtF4zctjKS2Khc1V4R5Z5RNsaUwbv0L5IbiaUWrYwA/640?wx_fmt=other&from=appmsg)

è®¾ç½®å…è®¸è·¨åŸŸ
------

å¯ä»¥è‡ªå·±æ‰‹åŠ¨è®¾ç½®å“åº”å¤´å®ç°è·¨åŸŸï¼Œæˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨`cors`åº“

```
bash
npmÂ iÂ cors


```

```
constÂ corsÂ =Â require('cors');
app.use(cors());Â //Â è¿™æ¡éœ€è¦æ”¾åœ¨Â constÂ appÂ =Â express();Â å


```

æ­¤æ—¶é‡æ–°è¿è¡Œåå°ï¼Œå†è§‚å¯Ÿ

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljKEF2dLxZRFSQWl0bLKeUPxBZC1nYxgicibX0N4iaPuh2Z5erNMqCgdib8A/640?wx_fmt=other&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljV1lcXibWLFI0FT7VibOKTh7KffA5O7icFzBSFAkRjk1rF3pXuRkahmoaw/640?wx_fmt=other&from=appmsg)![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljdwOkT4gY18kCKz0V3yyx3aPtcJ9McYqyqxGuPIue6RchGAibJHe7eCw/640?wx_fmt=other&from=appmsg)

æ­¤æ—¶å‘ç°ï¼Œè§£æ map æ–‡ä»¶æŠ¥é”™äº†ï¼Œé‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä¸Šä¼  map æ–‡ä»¶

åœ¨`server.js`åŒçº§ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª`uploads`æ–‡ä»¶å¤¹

å›åˆ°æ‰“åŒ… vue æ‰“åŒ…æ–‡ä»¶ç›®å½•`dist`ï¼Œå°† js æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰`js.map`ç»“å°¾çš„æ–‡ä»¶å‰ªåˆ‡åˆ°åˆ›å»ºçš„æ–‡ä»¶å¤¹ä¸­ï¼Œå¦‚æœä½ æ‰“åŒ…æ–‡ä»¶ä¸­æ²¡æœ‰`js.map`ï¼Œé‚£æ˜¯å› ä¸ºä½ æ²¡æœ‰æ‰“å¼€ç”Ÿæˆ`js.map`çš„å¼€å…³ï¼Œæ‰“å¼€`vue.config.js`, åœ¨`defineConfig`ä¸­è®¾ç½®å±æ€§`productionSourceMap`ä¸º`true`ï¼Œç„¶åé‡æ–°æ‰“åŒ…å°±å¯ä»¥äº†

```
module.exportsÂ =Â defineConfig({
Â Â productionSourceMap:Â true,Â //Â è®¾ç½®ä¸ºtrueï¼Œç„¶åé‡æ–°æ‰“åŒ…
Â Â transpileDependencies:Â true,
Â Â lintOnSave:Â false,
Â Â configureWebpack:Â {
Â Â Â Â devServer:Â {
Â Â Â Â Â Â client:Â false
Â Â Â Â }
Â Â }
})


```

> **ä¸ºä»€ä¹ˆæ˜¯å‰ªåˆ‡ï¼Ÿå¦‚æœçœŸæ­£çš„é¡¹ç›®ä¸Šçº¿æ—¶ï¼Œä½ æŠŠ`js.map`æ–‡ä»¶ä¸Šä¼ äº†ï¼Œåˆ«äººæ‹¿åˆ°ä¹‹åæ˜¯å¯ä»¥çŸ¥é“ä½ çš„æºç çš„ï¼Œæ‰€ä»¥å¿…é¡»å‰ªåˆ‡ï¼Œæˆ–è€…å¤åˆ¶ä¹‹åå›åˆ°`dist`ç›®å½•åˆ æ‰æ‰€æœ‰`js.map`**

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljGd5LJBWNJ8y4BrBCmqF7XrALZcF46EMicAw9ca2r0J9YZUrPKia3axRQ/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljN7ze7GY4C9wdT3rtdpu8wklwiaCMSnByHtAmtye0jbfQSruRricyXnyw/640?wx_fmt=other&from=appmsg)  
  

è¿™æ—¶å€™æˆ‘ä»¬å†åˆ·æ–°ç½‘é¡µï¼Œç„¶åçœ‹åå°çš„è¾“å‡ºï¼Œæ˜¾ç¤º`src/App.vue`çš„ç¬¬ 10 è¡Œæœ‰é”™

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljTFPvFYgv5zDf5J846UvXpJ6seg2QXsZOdCqvJS8v9TDxQxCbJibiaybQ/640?wx_fmt=other&from=appmsg)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljHa2CdIEGM7KPZZVHNlum3md077ztFkdrjSRQEHc09wqOdiaGtF1p3Yw/640?wx_fmt=other&from=appmsg)

  

ç¼–å†™ window é”™è¯¯ä¸Šä¼ æ¥å£
----------------

```
//Â å¤„ç†WindowæŠ¥é”™
app.post('/reportWindowError',asyncÂ (req,Â res)Â =>Â {
Â Â constÂ urlParamsÂ =Â req.body;
Â Â console.log(`æ”¶åˆ°Windowé”™è¯¯æŠ¥å‘Š`);
Â Â console.log('urlParams',Â urlParams);

Â Â res.send({
Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ',
Â Â Â Â status:Â 200,
Â Â }).status(200);
})


```

æ­¤æ—¶æˆ‘ä»¬å» vue é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ª img æ ‡ç­¾ï¼Œè·å–ä¸€å¼ ä¸å­˜åœ¨çš„å›¾ç‰‡å³å¯å‡ºå‘é”™è¯¯ï¼Œç”±äºä¸ç”¨è§£æï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†ä¸Šä¼ `js.map`äº†

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljEaEu58GbrzBOm0LWnsu3k6pBvHia9EuicvgctgC0ickrhIFHMaZw0gHtQ/640?wx_fmt=other&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljT2VCibs6GrbJHe5eGEnZmSX1O78zcCNumOuE078wuqTQZhdgFO9akOA/640?wx_fmt=other&from=appmsg)

  

å†™å…¥æ—¥å¿—
----

é”™è¯¯ä¸ŠæŠ¥ä¹‹åæˆ‘ä»¬éœ€è¦è®°å½•ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹æ¥å£ï¼Œæ”¶åˆ°æŠ¥é”™ä¹‹åå†™ä¸€ä¸‹æ—¥å¿—

æˆ‘éœ€è¦çŸ¥é“å“ªä¸€å¤©çš„æ—¥å¿—æŠ¥é”™äº†ï¼Œæ‰€æœ‰æˆ‘åœ¨ node é¡¹ç›®ä¸­ä¹Ÿä¸‹è½½`dayjs`ç”¨æ¥æ ¼å¼åŒ–æ—¶é—´

```
npmÂ iÂ dayjs


```

æ­¤å¤„çš„æ—¥å¿—è®°å½•å†…å®¹åªæ˜¯æˆ‘è‡ªå·±éœ€è¦çš„æ ¼å¼ï¼Œå¦‚æœä½ éœ€è¦å…¶ä»–æ ¼å¼è¯·è‡ªå·±å¦å¤–æ·»åŠ 

### vue é”™è¯¯å†™å…¥æ—¥å¿—

```
//Â letÂ sourceMapParseResultÂ =Â '';
//Â tryÂ {
//Â Â //Â è§£æsourceMapç»“æœ
//Â Â sourceMapParseResultÂ =Â awaitÂ searchSource({Â filePath,Â line:Â stack.line,Â column:Â //stack.columnÂ });
//}Â catchÂ (err)Â {
//Â Â sourceMapParseResultÂ =Â err;
//}
//console.log('è§£æç»“æœ',Â sourceMapParseResult)

//Â ç›´æ¥å°†ä¸‹é¢çš„å†…å®¹ç²˜è´´åœ¨ä¸Šé¢çš„logä¸‹é¢

constÂ todayÂ =Â dayjs().format('YYYY-MM-DD')Â //Â ä»Šå¤©

constÂ logDirPathÂ =Â path.join(__dirname,Â 'log');
constÂ logFilePathÂ =Â path.resolve(__dirname,Â 'log/'Â +Â `log-${today}.txt`)

ifÂ (!fs.existsSync(logDirPath))Â {
Â Â console.log(`åˆ›å»ºlogæ–‡ä»¶å¤¹`)
Â Â fs.mkdirSync(logDirPath,Â {Â recursive:Â trueÂ });
}
ifÂ (!fs.existsSync(logFilePath))Â {
Â Â console.log(`åˆ›å»º${today}æ—¥å¿—æ–‡ä»¶`)
Â Â fs.writeFileSync(logFilePath,Â '',Â 'utf8');
}

constÂ writeStreamÂ =Â fs.createWriteStream(logFilePath,Â {Â flags:Â 'a'Â });
writeStream.on('open',Â ()Â =>Â {
Â Â //Â writeStream.write('UUIDï¼š'Â +Â urlParams.data.uuidÂ +Â '\n');
Â Â writeStream.write('é”™è¯¯ç±»å‹ï¼šWindow'Â +Â '\n');
Â Â writeStream.write('é”™è¯¯å‘ç”Ÿæ—¶é—´ï¼š'Â +Â urlParams.data.errTimeÂ +Â '\n');
Â Â writeStream.write('IPï¼š'Â +Â req.ipÂ +Â '\n');
Â Â writeStream.write(`å®‰å“:Â ${urlParams.data.isAndroid}Â IOS:Â ${urlParams.data.isIOS}Â ç§»åŠ¨ç«¯:Â ${urlParams.data.isMobile}Â å¾®ä¿¡:Â ${urlParams.data.isWechat}Â ï¼ˆå®‰å“å’ŒiosåŒæ—¶ä¸ºfalseè¡¨ç¤ºæœªçŸ¥è®¾å¤‡ï¼‰`Â +Â '\n');
Â Â writeStream.write('ç”¨æˆ·ä»£ç†ï¼š'Â +Â urlParams.browserInfo.userAgentÂ +Â '\n');
Â Â writeStream.write('é”™è¯¯ä¿¡æ¯ï¼š'Â +Â urlParams.error.messageÂ +Â '\n');
Â Â writeStream.write('----------------------------------Â \n');

Â Â writeStream.end(()Â =>Â {
Â Â Â Â console.log('vueé”™è¯¯æ—¥å¿—å†™å…¥æˆåŠŸ');
Â Â Â Â console.log('---------------------');
Â Â Â Â res.send({
Â Â Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ',
Â Â Â Â Â Â status:Â 200,
Â Â Â Â }).status(200);
Â Â });
})

writeStream.on('error',Â errÂ =>Â {
Â Â res.send({
Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥å¤±è´¥',
Â Â Â Â status:Â 404,
Â Â }).status(404);
Â Â console.error('å‘ç”Ÿé”™è¯¯:',Â err);
})


```

### window é”™è¯¯å†™å…¥æ—¥å¿—

å’Œ vue å†™å…¥çš„æ–¹å¼å·®ä¸å¤šï¼Œå­˜åœ¨ä¼˜åŒ–ç©ºé—´

```
constÂ todayÂ =Â dayjs().format('YYYY-MM-DD')Â //Â ä»Šå¤©

constÂ logDirPathÂ =Â path.join(__dirname,Â 'log');
constÂ logFilePathÂ =Â path.join(__dirname,Â 'log'Â +Â `/log-${today}.txt`)

ifÂ (!fs.existsSync(logDirPath))Â {
Â Â console.log(`åˆ›å»ºlogæ–‡ä»¶å¤¹`)
Â Â fs.mkdirSync(logDirPath,Â {Â recursive:Â trueÂ });
}
ifÂ (!fs.existsSync(logFilePath))Â {
Â Â console.log(`åˆ›å»º${today}æ—¥å¿—æ–‡ä»¶`)
Â Â fs.writeFileSync(logFilePath,Â '',Â 'utf8');
}

constÂ writeStreamÂ =Â fs.createWriteStream(logFilePath,Â {Â flags:Â 'a'Â });
writeStream.on('open',Â ()Â =>Â {
Â Â writeStream.write('é”™è¯¯ç±»å‹ï¼šWindow'Â +Â '\n');
Â Â writeStream.write('é”™è¯¯å‘ç”Ÿæ—¶é—´ï¼š'Â +Â urlParams.data.errTimeÂ +Â '\n');
Â Â writeStream.write('IPï¼š'Â +Â req.ipÂ +Â '\n');
Â Â writeStream.write(`å®‰å“:Â ${urlParams.data.isAndroid}Â IOS:Â ${urlParams.data.isIOS}Â ç§»åŠ¨ç«¯:Â ${urlParams.data.isMobile}Â å¾®ä¿¡:Â ${urlParams.data.isWechat}Â ï¼ˆå®‰å“å’ŒiosåŒæ—¶ä¸ºfalseè¡¨ç¤ºæœªçŸ¥è®¾å¤‡ï¼‰`Â +Â '\n');
Â Â writeStream.write('ç”¨æˆ·ä»£ç†ï¼š'Â +Â urlParams.browserInfo.userAgentÂ +Â '\n');
Â Â writeStream.write('é”™è¯¯ä¿¡æ¯ï¼š'Â +Â urlParams.error.messageÂ +Â '\n');
Â Â writeStream.write('----------------------------------Â \n');

Â Â writeStream.end(()Â =>Â {
Â Â Â Â console.log('windowé”™è¯¯æ—¥å¿—å†™å…¥æˆåŠŸ');
Â Â Â Â console.log('---------------------');
Â Â Â Â res.send({
Â Â Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥æˆåŠŸ',
Â Â Â Â Â Â status:Â 200,
Â Â Â Â }).status(200);
Â Â });
})

writeStream.on('error',Â errÂ =>Â {
Â Â res.send({
Â Â Â Â data:Â 'é”™è¯¯ä¸ŠæŠ¥å¤±è´¥',
Â Â Â Â status:Â 404,
Â Â }).status(404);
Â Â console.error('å‘ç”Ÿé”™è¯¯:',Â err);
})


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljJQu51KkPqt5kOV5clDXP3pUMfEcic4EgWq84g6ndzAc166EJ9jOics0w/640?wx_fmt=other&from=appmsg)

  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljuc4GiaqzYibQOen48HmVAc3WPrDIL3icibEsuzQckwJMQkdxlp3gCg1XVg/640?wx_fmt=other&from=appmsg)

  

è‡³æ­¤ï¼Œæ”¶é›†é”™è¯¯ï¼Œä¸ŠæŠ¥é”™è¯¯ï¼Œå†™å…¥æ—¥å¿—å·²ç»å…¨éƒ¨å®Œæˆã€‚

å…¶ä»–
==

é”™è¯¯ç›‘æ§æŒä¹…åŒ–è¿è¡Œåœ¨æœåŠ¡å™¨
-------------

è¿™ä¸ªå¯ä»¥ä½¿ç”¨`pm2`ï¼Œåœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ node å…¨å±€å®‰è£…`pm2`åº“

```
pm2Â lsÂ #æ˜¾ç¤ºæ‰€æœ‰pm2å¯åŠ¨çš„åº”ç”¨
pm2Â startÂ /xxx/xxxÂ #Â å¯åŠ¨/xxx/xxxåº”ç”¨
pm2Â saveÂ #Â ä¿å­˜å½“å‰åº”ç”¨åˆ—è¡¨
pm2Â stopÂ idÂ #Â idÂ é€šè¿‡pm2Â lsæŸ¥çœ‹
pm2Â logsÂ idÂ #Â æŸ¥çœ‹æ—¥å¿—


```

è‡ªåŠ¨ä¸Šä¼ `js.map`æ–‡ä»¶
--------------

å¦‚æœæ¯æ¬¡æ‰“åŒ…åéƒ½æ‰‹åŠ¨å¤åˆ¶`js.map`æ–‡ä»¶çš„åˆ°`uploads`æ–‡ä»¶å¤¹ä¸‹ï¼Œä¼¼ä¹æœ‰äº›éº»çƒ¦

è™½ç„¶éº»çƒ¦ï¼Œä½†æ˜¯æˆ‘è‡ªå·±è¿˜æ˜¯æ²¡æœ‰è‡ªåŠ¨ä¸Šä¼ ï¼ŒåŸå› æ˜¯å¦‚æœæ‰“åŒ…å°±è‡ªåŠ¨ä¸Šä¼ ï¼Œé‚£ä¹ˆå¦‚æœé¡¹ç›®è¿˜æœªå‘å¸ƒï¼Œä½†æ˜¯æ–‡ä»¶å·²ç»æ›¿æ¢æ‰ä¹‹å‰çš„æ–‡ä»¶äº†ï¼Œæ–°ç‰ˆæœ¬æœªå‘å¸ƒä¹‹å‰ï¼Œvue çš„é”™è¯¯å°±æ— æ³•è§£æäº†ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ æ¯æ¬¡ä¸Šä¼ éƒ½ä¸åˆ é™¤ä»¥å‰çš„æ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„

### ä¿®æ”¹ vue é¡¹ç›®

åœ¨ vue é¡¹ç›®`src`ä¸‹åˆ›å»ºä¸€ä¸ª`plugin`ç›®å½•ï¼Œæ–°å»ºä¸€ä¸ª`UploadSourceMap.js`ï¼Œå°†ä¸‹é¢çš„ä»£ç ç²˜è´´è¿›å»

```
constÂ globÂ =Â require('glob')
constÂ pathÂ =Â require('path')
constÂ httpÂ =Â require('http')
constÂ fsÂ =Â require('fs')

classÂ UploadSourceMapÂ {
Â Â constructorÂ (options)Â {
Â Â Â Â this.optionsÂ =Â options
Â Â }

Â Â applyÂ (compiler)Â {
Â Â Â Â console.log('UploadSourceMap')

Â Â Â Â //Â åœ¨æ‰“åŒ…å®Œæˆåè¿è¡Œ
Â Â Â Â compiler.hooks.done.tap('UploadSourceMap',Â asyncÂ statsÂ =>Â {
Â Â Â Â Â Â constÂ listÂ =Â glob.sync(path.join(stats.compilation.outputOptions.path,Â '**/*.js.map'))
Â Â Â Â Â Â forÂ (constÂ itemÂ ofÂ list)Â {
Â Â Â Â Â Â Â Â constÂ fileNameÂ =Â path.basename(item);
Â Â Â Â Â Â Â Â console.log(`å¼€å§‹ä¸Šä¼ ${fileName}`)
Â Â Â Â Â Â Â Â awaitÂ this.upload(this.options.url,Â item)
Â Â Â Â Â Â Â Â console.log(`ä¸Šä¼ ${fileName}å®Œæˆ`)
Â Â Â Â Â Â }
Â Â Â Â })
Â Â }

Â Â uploadÂ (url,Â file)Â {
Â Â Â Â returnÂ newÂ Promise((resolve,Â reject)Â =>Â {
Â Â Â Â Â Â constÂ reqÂ =Â http.request(
Â Â Â Â Â Â Â Â `${url}/upload?name=${path.basename(file)}`,
Â Â Â Â Â Â Â Â {
Â Â Â Â Â Â Â Â Â Â method:Â 'POST',
Â Â Â Â Â Â Â Â Â Â headers:Â {
Â Â Â Â Â Â Â Â Â Â Â Â 'Content-Type':Â 'application/octet-stream',
Â Â Â Â Â Â Â Â Â Â Â Â Connection:Â 'keep-alive',
Â Â Â Â Â Â Â Â Â Â Â Â 'Transfer-Encoding':Â 'chunked'
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â )
Â Â Â Â Â Â fs.createReadStream(file)
Â Â Â Â Â Â Â Â .on('data',Â chunkÂ =>Â {
Â Â Â Â Â Â Â Â Â Â req.write(chunk)
Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â .on('end',Â ()Â =>Â {
Â Â Â Â Â Â Â Â Â Â req.end()
Â Â Â Â Â Â Â Â Â Â //Â åˆ é™¤æ–‡ä»¶
Â Â Â Â Â Â Â Â Â Â fs.unlink(file,Â (err)Â =>Â {
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ (err)Â {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error(err)
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â Â Â resolve()
Â Â Â Â Â Â Â Â })
Â Â Â Â })
Â Â }
}

module.exportsÂ =Â UploadSourceMap


```

ä¿®æ”¹`vue.config.js`

ä¸»è¦æ˜¯å¼•å…¥`UploadSourceMap`ï¼Œå¹¶ä¸”åœ¨`configureWebpack` => `plugins`ä¸‹ä½¿ç”¨

```
constÂ {Â defineConfigÂ }Â =Â require('@vue/cli-service')
constÂ UploadSourceMapÂ =Â require('./src/plugin/UploadSourceMap')

module.exportsÂ =Â defineConfig({
Â Â productionSourceMap:Â true,
Â Â transpileDependencies:Â true,
Â Â lintOnSave:Â false,
Â Â configureWebpack:Â {
Â Â Â Â plugins:Â [
Â Â Â Â Â Â newÂ UploadSourceMap({
Â Â Â Â Â Â Â Â url:Â 'http://127.0.0.1:9999'Â //Â åé¢æ¢æˆè‡ªå·±çš„æœåŠ¡å™¨åœ°å€
Â Â Â Â Â Â })
Â Â Â Â ]
Â Â }
})


```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4lj0lpn96wC2nWBUPdYZCWOhyadzibauXPn7Uj7t4eugSjCmQQvXCv4GDw/640?wx_fmt=other&from=appmsg)

  

### ä¿®æ”¹åå°

ä¿®æ”¹`server.js`ï¼Œæ–°å¢ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æ¥å£

```
app.post('/upload',Â (req,Â res)Â =>Â {
Â Â constÂ fileNameÂ =Â req.query.name
Â Â constÂ filePathÂ =Â path.join(__dirname,Â 'uploads',Â fileName)

Â Â ifÂ (!fs.existsSync(path.dirname(filePath)))Â {
Â Â Â Â fs.mkdirSync(path.dirname(filePath),Â {Â recursive:Â trueÂ })
Â Â }

Â Â constÂ writeStreamÂ =Â fs.createWriteStream(filePath)

Â Â req.on('data',Â (chunk)Â =>Â {
Â Â Â Â writeStream.write(chunk)
Â Â })

Â Â req.on('end',Â ()Â =>Â {
Â Â Â Â writeStream.end(()Â =>Â {
Â Â Â Â Â Â res.status(200).send(`FileÂ ${fileName}Â hasÂ beenÂ saved.`)
Â Â Â Â })
Â Â })

Â Â writeStream.on('error',Â (err)Â =>Â {
Â Â Â Â fs.unlink(filePath,Â ()Â =>Â {
Â Â Â Â Â Â console.error(`ErrorÂ writingÂ fileÂ ${fileName}:Â ${err}`)
Â Â Â Â Â Â //Â res.status(500).send(`ErrorÂ writingÂ fileÂ ${fileName}.`)
Â Â Â Â })
Â Â })
})


```

ç„¶åç°åœ¨é‡æ–°æ‰“åŒ…ï¼Œè§‚å¯Ÿæ‰“åŒ…è¾“å‡º

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1ubnvHJ2tRAuMhNbAo0QL4ljZ7ibmRibcxQ7LzIBFQmqaeefHoW30ptRE85nicL7PhQyMmZEfldSP28Sg/640?wx_fmt=other&from=appmsg)

æœ€å
==

å°½é‡æ˜¯ä¸è¦å¼€å¯è·¨åŸŸï¼Œå¦åˆ™è°éƒ½èƒ½ç»™å‘è¯·æ±‚åˆ°åå°ï¼Œå¦‚æœè¦å¼€è·¨åŸŸï¼Œé‚£éœ€è¦åšå¥½åˆ¤æ–­ï¼Œä¸»åŸŸåä¸ç¬¦åˆçš„ç›´æ¥è¿”å› 404 ç»ˆæ­¢è¿™æ¬¡è¯·æ±‚ã€‚

å¸‚é¢ä¸Šçš„ç›‘æ§æœ‰å¾ˆå¤šï¼Œæœ‰äº›ç”šè‡³èƒ½å®ç°å½•åˆ¶ç”¨æˆ·æ“ä½œç”Ÿæˆ gifï¼Œæœ¬æ–‡åªæ˜¯å®ç°ä¸€ä¸ªåŸºæœ¬çš„é”™è¯¯ç›‘æ§ï¼Œå¦‚æœ‰é”™è¯¯è¯·æŒ‡å‡ºã€‚

æºç å‚è€ƒï¼šhttps://github.com/liuxulin0626/error-monitor-demo

**åŸæ–‡åœ°å€ï¼šhttps://juejin.cn/post/7383955****685368086562**

**ä½œè€…ï¼šç”¨æˆ·ä¸ä¼šåƒä½ è¿™ä¹ˆæ“ä½œçš„**

å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚

```
Node ç¤¾ç¾¤




æˆ‘ç»„å»ºäº†ä¸€ä¸ªæ°›å›´ç‰¹åˆ«å¥½çš„ Node.js ç¤¾ç¾¤ï¼Œé‡Œé¢æœ‰å¾ˆå¤š Node.jså°ä¼™ä¼´ï¼Œå¦‚æœä½ å¯¹Node.jså­¦ä¹ æ„Ÿå…´è¶£çš„è¯ï¼ˆåç»­æœ‰è®¡åˆ’ä¹Ÿå¯ä»¥ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·è¿›è¡ŒNode.jsç›¸å…³çš„äº¤æµã€å­¦ä¹ ã€å…±å»ºã€‚ä¸‹æ–¹åŠ  è€ƒæ‹‰ å¥½å‹å›å¤ã€ŒNodeã€å³å¯ã€‚

Â Â Â â€œåˆ†äº«ã€ç‚¹èµã€åœ¨çœ‹â€ æ”¯æŒä¸€æ³¢ğŸ‘

```