> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/bBhcMtM8IT0t66rKyom-XQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3urKmWhM19NyfviczHR7sFuia24PKONKWq988TTYKPy4qIwSB5JfK6Duibw/640?wx_fmt=png)State of JS

è¿™ç¯‡æ–‡ç« ç»§ç»­æˆ‘ä»¬çš„â€˜è·¨å¹³å°â€™ä¹‹æ—…ï¼Œ ä¹‹å‰æˆ‘ä»¬èŠè¿‡:

*   ç¼–å†™â€˜è·¨ç‰ˆæœ¬â€™ çš„ç»„ä»¶åº“ï¼š å¦‚ä½•å®ç°æ”¯æŒè·¨ Vue 2/3 çš„ç»„ä»¶åº“
    
*   ç¼–å†™â€˜è·¨æ¡†æ¶â€™çš„ç»„ä»¶ï¼šæ¥ä¸€ç“¶ Web Component é­”æ³•èƒ¶æ°´
    
*   è·¨å¹³å°çš„è¿è¡Œå®¹å™¨ï¼š ä½¿ç”¨ Docker å®ç°å‰ç«¯åº”ç”¨çš„æ ‡å‡†åŒ–æ„å»ºã€éƒ¨ç½²å’Œè¿è¡Œ
    
*   ç¼–å†™è·¨è¿è¡Œæ—¶çš„ç¨‹åº
    

ä»Šå¤©ç»§ç»­æ¥èŠä¸€ä¸‹æ€ä¹ˆç¼–å†™â€˜è·¨å¹³å°â€™çš„æ„å»ºæ’ä»¶ï¼Œå‰ç«¯æ„å»ºå·¥å…·ä¸€ç›´éƒ½æ˜¯ä¸€ä¸ªæ¯”è¾ƒå·çš„èµ›é“ï¼Œæ¯•ç«Ÿå®ƒæ˜¯å‰ç«¯å·¥ç¨‹åŒ–çš„é‡è¦ä¸€ç¯ï¼Œæ­¤æ—¶æ­¤åˆ»å®ƒæ­£åœ¨ç»å†ç€æ–°ä¸€è½®çš„å˜é© â€”â€” ä½¿ç”¨ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ (å¦‚ Rustã€Go) é‡æ„ã€‚

ä» Webpackã€Parcelï¼Œåˆ° Vite, å†åˆ° Turbopackã€Rspackã€Bunâ€¦ ç™¾èŠ±é½æ”¾ã€‚

é‚£é—®é¢˜åˆæ¥äº†ï¼Œæ–°çš„æ„å»ºå·¥å…·å‡ºæ¥ï¼Œæ„å‘³ç€åˆæœ‰æ–°çš„ â€œæŠ€æœ¯å€ºâ€ äº§ç”Ÿã€‚

åœ¨è¿™ä¸ªæŠ€æœ¯å¿«é€Ÿå‘å±•çš„æ—¶ä»£ï¼Œæ–°æ—§å¹¶å­˜çš„å±€é¢æ²¡åŠæ³•é¿å…ã€‚ä½œä¸ºåº“çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„åº“èƒ½å¤ŸæœåŠ¡æ›´å¤šçš„äººï¼Œé‚£ â€œè·¨å¹³å°â€ æ˜¯æˆ‘ä»¬ä¸å¾—ä¸è€ƒè™‘çš„é—®é¢˜ã€‚

  

**æ€ä¹ˆå¼€å‘ä¸€ä¸ªè·¨å¹³å°çš„æ„å»ºæ’ä»¶å‘¢ï¼Ÿ**

é¦–å…ˆæˆ‘ä»¬è¦ç«™åœ¨æ›´é«˜çš„è§’åº¦å®¡è§†è¿™äº›æ„å»ºå·¥å…·ï¼Œè¿™äº›æ„å»ºå·¥å…·ä¸»è¦åšä»€ä¹ˆå·¥ä½œï¼Ÿä»å®ƒä»¬æš´éœ²çš„æ’ä»¶ API ä¸­æŠ½è±¡å…±æ€§ã€‚è¿™äº›æ„å»ºå·¥å…·ç›®çš„éƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ— éå°±æ˜¯:

*   æ–‡ä»¶é¢„å¤„ç† / è½¬æ¢ã€‚æ¯”å¦‚ sassã€typescriptã€imageã€icon ç­‰ï¼Œå‰ç«¯éœ€è¦å¤„ç†çš„å„ç±»èµ„æºçš„å¤„ç†
    
*   ä¾èµ–å…³ç³»å¤„ç†ã€‚è§£æå’Œå¤„ç†æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»
    
*   ä»£ç è¾“å‡ºã€‚åŒ…å«ä»£ç åˆå¹¶ã€ä»£ç ä¼˜åŒ–ã€äº§ç‰©è¾“å‡ºç­‰ã€‚
    

ä¸»è¦çš„å·®å¼‚ç‚¹æ— éå°±æ˜¯å®ç°ä¸åŒï¼Œè¿›è€Œåœ¨æ‰©å±•æ€§ã€æ„å»ºæ€§èƒ½ä¸Šé¢ä¹Ÿä¼šæœ‰ä¸åŒçš„è¡¨ç°ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æŒ‘ä¸¤ä¸ªç›®å‰æ¯”è¾ƒä¸»æµçš„æ„å»ºå·¥å…·æ¥å–µå–µçœ‹ï¼Œæˆ‘æŒ‘é€‰çš„æ˜¯ `Webpack` å’Œ `Rollup`ï¼ˆ Vite ä¹Ÿæ˜¯åŸºäº Rollup çš„ï¼Œä¸¤è€…å·®å¼‚ä¸å¤§ï¼‰ã€‚

Webpack
=======

å°½ç®¡è¿™å‡ å¹´å—åˆ°äº† Vite ç­‰æ–¹æ¡ˆçš„æŒ‘æˆ˜ï¼Œä½†ä¸å¾—ä¸æ‰¿è®¤ï¼ŒWebpack ä¾æ—§æ˜¯ç‹ï¼Œè‡³å°‘åœ¨ç”Ÿæ€å’Œå­˜é‡å¸‚åœºä¸Šã€‚

Webpack æ˜¯åŸºäº`äº‹ä»¶é©±åŠ¨`(Event Driven) çš„`æ’ä»¶å¼`ç¼–è¯‘å™¨ã€‚Webpack å°±æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„`å¾®å†…æ ¸`æ¶æ„ï¼Œ å¯ä»¥è¯´ Webpack çš„å†…æ ¸å°±æ˜¯ `Tapable`ï¼Œéå¸¸å°ã€éå¸¸ä¼˜é›…ã€‚éå¸¸å€¼å¾—æˆ‘ä»¬å»åå¤å’€åš¼ç ”ç©¶

å‡ ä¹æ‰€æœ‰çš„åŠŸèƒ½ï¼Œä¸ç®¡æ˜¯å†…ç½®çš„ã€è¿˜æ˜¯ç¬¬ä¸‰æ–¹çš„éƒ½æ˜¯é€šè¿‡æ’ä»¶çš„å½¢å¼å®ç°ã€‚åŒ…æ‹¬æˆ‘ä»¬çœ‹åˆ°çš„æ‰€æœ‰çš„ webpack é…ç½®ï¼Œ éƒ½ä¼šè¢«è§£æè½¬æ¢æˆç›¸åº”çš„æ’ä»¶ï¼Œè€Œé…ç½®ä¸è¿‡æ˜¯æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨çš„`ç”¨æˆ·ç•Œé¢`ç½¢äº†

Webpack é€šè¿‡ `Tapable Hooks` æš´éœ²äº†ä¸°å¯Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæ”¯æŒå¼€å‘è€…å¯¹ç¼–è¯‘å™¨ã€æ¨¡å—æŸ¥æ‰¾ã€æ–‡ä»¶è½¬æ¢ã€ä¼˜åŒ–ã€äº§ç‰©ç”Ÿæˆçš„æ¯ä¸€ä¸ªç»†èŠ‚è¿›è¡Œå®šåˆ¶ã€‚

> ğŸ’¡Â  äº†è§£ Webpack çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚
> 
> *   `Compiler`ï¼šå³ Webpack ç¼–è¯‘å™¨æœ¬èº«ï¼Œå®ƒä»æ•´ä½“ä¸Šç®¡ç† Webpack çš„ç”Ÿå‘½å‘¨æœŸï¼Œè´Ÿè´£å¤„ç†é…ç½®ã€åŠ è½½æ’ä»¶ã€æ„é€ æ ¸å¿ƒçš„å¯¹è±¡ï¼ˆCompilationã€Resolverã€Modulefactory ç­‰ï¼‰ï¼Œå¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªå…¨å±€çš„ç®¡ç†è€…ã€‚
>     
> *   `Compilation`: ç”± Compiler åˆ›å»ºï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ Webpack çš„æ ¸å¿ƒå¤§è„‘ï¼ŒWebpack çš„å¤§éƒ¨åˆ†å·¥ä½œç”±å®ƒå®Œæˆï¼Œå®ƒåŒ…å«ä¾èµ–å›¾ (Dependency Graph) çš„æ„é€ ã€è´Ÿè´£æ¨¡å—æ„é€ ã€è½¬æ¢ã€ä¼˜åŒ–ã€èµ„æºè¾“å‡ºç­‰å„ç§æ ¸å¿ƒçš„æµç¨‹ã€‚
>     
> *   `Resolver`ï¼šæ¨¡å—æŸ¥æ‰¾å™¨ï¼Œç®€å•è¯´å°±æ˜¯å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
>     
> *   `Module`: JavaScript æ¨¡å—åœ¨ Webpack å†…çš„è¡¨ç¤º
>     
> *   `Module Factory`ï¼šModule æ„é€ å·¥å‚
>     
> *   `Parser`ï¼šè§£æ Module ä¸º AST, è·å–æ¨¡å—ä¾èµ–ã€‚
>     
> *   `Loader`: è´Ÿè´£å°†æ–‡ä»¶è¾“å…¥ (æ¯”å¦‚å›¾ç‰‡ã€CSSã€JavaScript æ–‡ä»¶ç­‰ç­‰) è½¬æ¢ä¸º Moduleã€‚Loader é€šå¸¸åªè´Ÿè´£æ— å‰¯ä½œç”¨çš„è½¬æ¢å·¥ä½œï¼ŒLoader æœ‰ç‚¹ç±»ä¼¼äº Shell å‘½ä»¤è¡Œ
>     
> *   `Plugin`: æ’ä»¶ï¼Œä¸º Webpack æ‰©å±•å®é™…çš„åŠŸèƒ½
>     

Webpack æš´éœ²äº†éå¸¸ä¸°å¯Œçš„ Hooksï¼Œè¿™äº› Hooks ä¸»è¦ç”±ä¸¤ä¸ªä¸»è¦çš„å¯¹è±¡ç®¡ç†ï¼Œå³ `Compiler` å’Œ `Compilation`ã€‚æ€ä¹ˆç†è§£è¿™ä¸¤ä¸ªå¯¹è±¡å‘¢ï¼Ÿä»ä¸¤ä¸ªè§’åº¦çœ‹ï¼š

*   ä»æ„å»ºå·¥å…·çš„è§’åº¦çœ‹ï¼Œ Compiler ä»£è¡¨çš„æ˜¯ Webpack æ„å»ºçš„æ•´ä½“æµç¨‹
    
*   ä»æ¨¡å—çš„è§’åº¦çœ‹ï¼Œ Compilation åˆ™è´Ÿè´£å…·ä½“æ¨¡å—çš„ç¼–è¯‘æµç¨‹
    

ä¸‹é¢ï¼Œæˆ‘æ•´ç† Compiler å’Œ Compilation æš´éœ²çš„å¸¸ç”¨çš„ hooks ä»¥åŠè°ƒç”¨çš„é¡ºåºã€‚å¯ä»¥ä¸€çª¥ Webpack çš„è¿è¡ŒåŸç†ã€‚

**Compiler ç”Ÿå‘½å‘¨æœŸ**ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uHPdcGB0BpdqumpKnT0uIO6gVeXnDOt9BsmLpKScNia4a0Uic8478C4DQ/640?wx_fmt=png)Compiler

**Compilation ç”Ÿå‘½å‘¨æœŸ**ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uYH4yCvmWIz5hXyaBwFCx8NIgib1PHUamaOQpz1zkHMVQafyDStA7CZQ/640?wx_fmt=png)Compilation

è¿™äº› Hooks çš„è¯¦æƒ…ä»‹ç»å’Œä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒ Webpack çš„æ–‡æ¡£ã€‚

**æˆ‘å»ºè®®ä½ å»ç›´æ¥å»çœ‹ Webpack çš„æºç ï¼ŒæŠ€å·§æ˜¯ï¼šæœç´¢å¯¹åº”çš„ Hooks æ˜¯æ€ä¹ˆè¢«è§¦å‘å’Œæ¶ˆè´¹çš„ï¼Œ å¯ä»¥å¸®åŠ©ä½ è¿›ä¸€æ­¥ç†è§£å®ƒä»¬çš„æ„ä¹‰ã€‚**

Rollup
======

è·Ÿ Webpack ç›¸æ¯”ï¼ŒRollup çš„ hooks æ›´åŠ ç²¾ç»ƒã€‚æ²¡æœ‰åƒ Webpack ä¸€æ ·åŒºåˆ† Compiler å’Œ Compillationï¼ŒLoader å’Œ Pluginã€‚

Webpack æš´éœ²äº†å¾ˆå¤š Hooksï¼Œæœ‰äº›æ–‡æ¡£ä¸Šéƒ½æ²¡æœ‰æåŠï¼Œç”šè‡³æœ‰äº›è¿ Webpack è‡ªå·±ä¹Ÿæ²¡ç”¨ä¸Šã€‚

å°½ç®¡è¿™æ ·å­å¯ä»¥ç»™å¼€å‘è€…å¾ˆå¤§çš„å®šåˆ¶ç©ºé—´ï¼Œä½†å¯¹äºåˆå­¦è€…æ¥è¯´ï¼Œå°±å¾ˆå®¹æ˜“è¢«è¿™äº›ç»†èŠ‚æ·¹æ²¡ã€‚

**Rollup æ„å»º Hooks**:

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uBW6xDcGU2qSibpmQGv5ibzo3BDtNr1u8Byb2iaqS6TJSvdY5sajyKp7kw/640?wx_fmt=png)Build hooks

*   `resolveId`: ç”¨äºè‡ªå®šä¹‰æ¨¡å—æŸ¥æ‰¾é€»è¾‘
    
*   `load`: ç”¨äºè‡ªå®šä¹‰æ¨¡å—åŠ è½½é€»è¾‘
    
*   `transform`ï¼šå¯ä»¥ç”¨äºè½¬æ¢æ¨¡å—
    
*   `moduleParsed`ï¼šæ¨¡å—å·²è§£æ
    

**Rollup ä»£ç ç”Ÿæˆ Hooks**:

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uxPSRPc12I9mXvh0Lz4RTWbKI7S2RgibUH2cqd33fhr3aK4DNkD9iaXrQ/640?wx_fmt=png)Emit Hooks

å­¦ä¹  Rollup æ’ä»¶çš„æœ€å¥½æ–¹å¼ï¼Œè¿˜æ˜¯å»ä¸´æ‘¹åˆ«äººæ€ä¹ˆå†™ï¼Œ å…ˆä»å®˜æ–¹çš„æ’ä»¶å¼€å§‹å§ã€‚

ç¼–å†™è·¨å¹³å°çš„æ’ä»¶
========

é™¤äº† Webpackã€Rollupï¼Œè¿˜æœ‰å¾ˆå¤šæ„å»ºå·¥å…·ä¸åœåœ°è¢«é€ å‡ºæ¥ï¼Œæœ‰æ²¡æœ‰åŠæ³•å¼€å‘ä¸€å¥—è·¨å¹³å°çš„æ’ä»¶å‘¢ï¼Ÿ

ç›®å‰æœ€ä½³ç­”æ¡ˆæ˜¯ unplugin, å®ƒçš„ä¸»è¦è´¡çŒ®è€…è¿˜æ˜¯ antfu å¤§ä½¬ã€‚

  

unplugin ä»¥ Rollup æ’ä»¶ API ä¸ºåŸºå‡†ï¼ŒRollup è¿™å¥— API éå¸¸ç²¾ç»ƒï¼Œè¿™ä¸ªæŠ½è±¡åŸºæœ¬å¯ä»¥è¦†ç›–åˆ°ä¸»æµçš„æ„å»ºå·¥å…·ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uib6NeGgics2B05OBOJy6CD3GQk6iaVN1PoTe4dHyhYqdpsdOFzian7F6ibg/640?wx_fmt=png)API

å¤§å®¶å¯ä»¥ç›´æ¥å»çœ‹æºç ï¼Œä»£ç å¹¶ä¸å¤šã€‚ä»¥ä¸‹æ˜¯ Webpack å’Œ unplugin API çš„æ˜ å°„å…³ç³»ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/OibzJoI7k4ILNJDIvjlX1ns1pKMulBe3uwtVPf3k13Qr3fhg3DfSsKyfexGXgYb9BbQr718xFDvATWpUhaoPKQQ/640?wx_fmt=png)Webpack to Rollup

å®æˆ˜
==

æ¥ä¸‹æ¥ï¼Œæ˜¯å®æˆ˜éƒ¨åˆ†ã€‚

æˆ‘åœ¨ ã€Šå‰ç«¯å¦‚ä½•ç ´è§£ CRUD çš„å¾ªç¯ã€‹ä»‹ç»äº†æˆ‘ä»¬çš„ç»„ä»¶åº“ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```
importÂ {Â defineFatFormÂ }Â fromÂ '@wakeadmin/components'importÂ {Â ElMessageBoxÂ }Â fromÂ 'element-plus'exportÂ defaultÂ defineFatForm<{Â Â //Â ğŸ”´Â è¿™é‡Œçš„æ³›å‹å˜é‡å¯ä»¥å®šä¹‰è¡¨å•æ•°æ®ç»“æ„Â Â name:Â stringÂ Â nickName:Â string}>(({Â item,Â form,Â consumer,Â groupÂ })Â =>Â {Â Â //Â ğŸ”´Â è¿™é‡Œå¯ä»¥æ”¾ç½®Â VueÂ HooksÂ Â //Â è¿”å›è¡¨å•å®šä¹‰Â Â returnÂ ()Â =>Â ({Â Â Â Â //Â FatFormÂ propsÂ å®šä¹‰Â Â Â Â initialValue:Â {Â Â Â Â Â Â name:Â 'ivan',Â Â Â Â Â Â nickName:Â 'ç‹—è›‹',Â Â Â Â },Â Â Â Â submit:Â asyncÂ (values)Â =>Â {Â Â Â Â Â Â awaitÂ ElMessageBox.confirm('ç¡®è®¤ä¿å­˜')Â Â Â Â Â Â console.log('ä¿å­˜æˆåŠŸ',Â values)Â Â Â Â },Â Â Â Â //Â ğŸ”´Â å­èŠ‚ç‚¹Â Â Â Â children:Â [Â Â Â Â Â Â item({Â prop:Â 'name',Â label:Â 'è´¦å·å'Â }),Â Â Â Â Â Â item({Â Â Â Â Â Â Â Â prop:Â 'nickName',Â Â Â Â Â Â Â Â label:Â 'æ˜µç§°',Â Â Â Â Â Â }),Â Â Â Â ],Â Â })})
```

ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒdefineFatForm è¿™ç§å†™æ³•ä¸æ”¯æŒçƒ­æ›´æ–°ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½ä¼šé‡åˆ·é¡µé¢ï¼Œä½“éªŒå¾ˆå·®ã€‚

å› æ­¤ä»Šå¤©æˆ‘ä»¬å°±æ¥å†™ä¸€ä¸ªæ’ä»¶ï¼Œè®©æˆ‘ä»¬çš„ç»„ä»¶åº“ define* å†™æ³•ä¹Ÿæ”¯æŒåƒ Vue defineComponent ä¸€æ ·çš„çƒ­æ›´æ–°ã€‚

> defineComponent çš„çƒ­æ›´æ–°å®ç°å¯ä»¥å‚è€ƒ @vitejs/plugin-vue-js

Vue çƒ­æ›´æ–°åˆè¯†
---------

æ¥ç®€å•çœ‹çœ‹ Vue æ˜¯æ€ä¹ˆå®ç°çƒ­æ›´æ–°

åœ¨ `SFC` ï¼ˆSingle File Componentï¼‰æ–‡ä»¶ç¼–è¯‘ä¹‹åï¼ŒVue æ’ä»¶ä¼šæ³¨å…¥ä»¥ä¸‹ä»£ç :

```
//Â ğŸ”´Â _sfc_mainÂ æ˜¯Â SFCÂ ç¼–è¯‘å‡ºæ¥çš„Â VueÂ ComponentÂ ç»„ä»¶_sfc_main.__hmrIdÂ =Â 'æ¨¡å—ID'//Â ğŸ”´Â æ³¨å†Œç»„ä»¶è®°å½•typeofÂ __VUE_HMR_RUNTIME__Â !==Â 'undefined'Â &&Â __VUE_HMR_RUNTIME__.createRecord(_sfc_main.__hmrId,Â _sfc_main)exportÂ constÂ _rerender_onlyÂ =Â true//Â ğŸ”´Â viteÂ çƒ­æ›´æ–°import.meta.hot.(modÂ =>Â {Â Â //Â ğŸ”´Â å½“å‰æ¨¡å—æ›´æ–°åä¼šè§¦å‘å½“å‰å›è°ƒÂ Â ifÂ (!mod)Â returnÂ Â constÂ {Â default:Â updated,Â _rerender_onlyÂ }Â =Â modÂ Â ifÂ (_rerender_only)Â {Â Â Â Â //Â ğŸ”´Â SFCÂ å¯ä»¥æ”¯æŒæ›¿æ¢Â renderï¼Œä¸ä¼šä¸¢å¤±çŠ¶æ€ï¼Œå¼€å‘ä½“éªŒä¼šæ›´å¥½ï¼ŒÂ Â Â Â __VUE_HMR_RUNTIME__.rerender(updated.__hmrId,Â updated.render)Â Â }Â elseÂ {Â Â Â Â //Â ğŸ”´Â å¦‚æœæ˜¯Â defineComponentÂ å°±è¿™é‡Œèµ°è¿™é‡Œäº†ï¼Œä¼šè§¦å‘Â parentÂ å®Œå…¨é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼ŒçŠ¶æ€ä¼šä¸¢å¤±Â Â Â Â __VUE_HMR_RUNTIME__.reload(updated.__hmrId,Â updated)Â Â }})
```

Vue å†…éƒ¨æ˜¯æ€ä¹ˆå®ç° `HMR` çš„å‘¢ï¼Ÿ

*   `__VUE_HMR_RUNTIME__.createRecord(æ¨¡å—ID, ç»„ä»¶)` ä¼šå°† â€œ`ç»„ä»¶å®ç°`â€ æ”¾åˆ°ä¸€ä¸ªå…¨å±€ Map ä¸­ï¼Œå’Œ `æ¨¡å— ID` å…³è”èµ·æ¥
    
*   ç»„ä»¶æŒ‚è½½æ—¶ï¼Œå°†ç»„ä»¶å®ä¾‹ + æ¨¡å— ID å…³è”èµ·æ¥ï¼š
    
    ```
    //Â æŒ‚è½½æ—¶æ³¨å†ŒifÂ (__DEV__Â &&Â instance.type.__hmrId)Â {Â Â registerHMR(instance)}
    ```
    
    Â   
    
    ç°åœ¨å…¨å±€ Map çš„ç»“æ„ç±»ä¼¼ï¼š
    
    ```
    constÂ recordsÂ =Â {Â Â [__hmrId]:Â {Â Â Â Â initialDef:Â ç»„ä»¶å®ç°ï¼ŒÂ Â Â Â instances:Â Set<[æ‰€æœ‰å·²æ¸²æŸ“çš„ç»„ä»¶å®ä¾‹]>Â Â }Â Â //Â ...}
    ```
    
*   ç»„ä»¶å¸è½½åï¼ŒåŒç†ä»è¿™ä¸ª Map ä¸­ç§»é™¤å®ä¾‹
    
*   rerender: æ›´æ–° initialDef å’Œæ‰€æœ‰ â€œç»„ä»¶å®ä¾‹â€ render æ–¹æ³•ï¼Œç„¶å update() æ‰€æœ‰ â€œç»„ä»¶å®ä¾‹â€
    
*   reloadï¼šæ›´æ–° initialDef, éå†æ‰€æœ‰ â€œç»„ä»¶å®ä¾‹â€ï¼Œè°ƒç”¨ â€œç»„ä»¶å®ä¾‹â€ parent èŠ‚ç‚¹ çš„ update() æ–¹æ³•ï¼Œé‡æ–°æ¸²æŸ“å½“å‰ç»„ä»¶
    

å®ç°
--

é¦–å…ˆï¼Œå¿«é€Ÿé€šè¿‡ unplugin-starter åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®æ¨¡æ¿ï¼š

```
$Â npxÂ degitÂ antfu/unplugin-starterÂ unplugin-wakeadmin-components
```

  

åœ¨é¡¹ç›®å‘½åä¸Šï¼Œéµå¾ª unplugin çš„è§„èŒƒï¼Œ ä½¿ç”¨ `unplugin-*` çš„å½¢å¼ï¼Œ Vite ä¸‹ï¼Œæ’ä»¶ç”¨æ³•å¦‚ä¸‹ï¼š

```
//Â vite.config.tsimportÂ WakeadminComponentsÂ fromÂ 'unplugin-wakeadmin-components/vite'exportÂ defaultÂ defineConfig({Â Â plugins:Â [Â Â Â Â WakeadminComponents({Â Â Â Â Â Â /*Â optionsÂ */Â Â Â Â }),Â Â ],})
```

  

å…ˆæ¥å†™ä¸€ä¸ª Hello worldï¼Œå°è¯•ç‰›åˆ€ã€‚

ç¬¬ä¸€æ­¥ï¼Œ æˆ‘ä»¬å…ˆç»™ `define*` æ–¹æ³•è°ƒç”¨åŠ ä¸Š `#__PURE__` æ³¨é‡Šï¼Œé¿å…è¢«è¯†åˆ«ä¸ºâ€˜å‰¯ä½œç”¨â€™ï¼Œè¿™ä¸ªæœ‰åˆ©äº Tree-Shaking å’Œ æ­»ä»£ç æ¶ˆé™¤ (Dead Code Elimination)ã€‚

è¯»è€…å¯ä»¥åœ¨ Terser REPL ä¸Šå¯¹æ¯”ä¸€ä¸‹ä»¥ä¸‹ä»£ç çš„ä¼˜åŒ–ç»“æœï¼š

```
//Â BÂ ä¸ä¼šè¢«æ¸…ç†æ‰constÂ AÂ =Â defineA({})constÂ BÂ =Â defineA({})console.log(A)
```

```
//Â BÂ ä¼šè¢«æ¸…ç†æ‰constÂ AÂ =Â /*#__PURE__*/Â defineA({})constÂ BÂ =Â /*#__PURE__*/Â defineA({})console.log(A)
```

ç°åœ¨å¼€å§‹å†™æ’ä»¶çš„å®ç°ã€‚é¦–å…ˆå®šä¹‰æ’ä»¶çš„`å‚æ•°`ï¼š

```
import type { ParserOptions } from '@babel/core'
import type { FilterPattern } from '@rollup/pluginutils'

export interface Options {
  /**
   * å¾…å¤„ç†çš„æ–‡ä»¶ï¼Œé»˜è®¤ ä¼šå¤„ç† .jsxã€.tsx æ–‡ä»¶
   */
  include?: FilterPattern
  exclude?: FilterPattern

  /**
   * æ˜¯å¦å¼€å¯ defineComponent çš„å¤„ç†ï¼Œé»˜è®¤ false
   */
  enabledDefineComponent?: boolean

  /**
   * babel parser æ’ä»¶ï¼Œé»˜è®¤ ['jsx']
   * å¦‚æœæ˜¯ tsx æ–‡ä»¶ï¼Œä¼šåŠ ä¸Š typescript
   */
  parserPlugins?: ParserOptions['plugins']

  /**
   * è°ƒè¯•æ¨¡å¼
   */
  debug?: boolean
}
```

æ¥ç€æ˜¯å®ç°ï¼š

```
import { UnpluginFactory, createUnplugin } from 'unplugin'
import { createFilter } from '@rollup/pluginutils'
import type { Options } from './types'
import babel, { PluginObj, ParserOptions } from '@babel/core'

const PLUGIN_NAME = 'unplugin-wakeadmin-components'
const t = babel.types

const DEFINE_FACTORIES = new Set(['defineFatTable', 'defineFatForm'])

function isDefineCall(node: babel.types.CallExpression) {
  return t.isIdentifier(node.callee) && DEFINE_FACTORIES.has(node.callee.name)
}

export const unpluginFactory: UnpluginFactory<Options | undefined> = (options, meta) => {
  const filter = createFilter(options?.include || /\.[jt]sx$/, options?.exclude)
  const enableDefineComponent = options?.enabledDefineComponent

  if (enableDefineComponent) {
    DEFINE_FACTORIES.add('defineComponent')
  }

  const REGEXP = new RegExp(`(${Array.from(DEFINE_FACTORIES).join('|')})`, 'g')

  return {
    name: PLUGIN_NAME,
    // ğŸ”´ é…ç½®ä¸º pre, åœ¨å…¶ä»– loader ä¹‹å‰å¤„ç†
    enforce: 'pre',
    // ğŸ”´ ç­›é€‰è¦è¢«è½¬æ¢çš„æ–‡ä»¶
    transformInclude(id) {
      const [filepath] = id.split('?')

      return filter(id) || filter(filepath)
    },
    //  ğŸ”´ è½¬æ¢é€»è¾‘
    transform(code, id) {
      if (code.match(REGEXP) == null) {
        // æ²¡æœ‰åŒ…å« define* è·³è¿‡
        return null
      }

      const plugins: PluginObj[] = []
      const parserPlugins: ParserOptions['plugins'] = ['jsx']

      if (id.endsWith('.tsx')) {
        parserPlugins.push('typescript')
      }

      if (options?.parserPlugins) {
        parserPlugins.push(...options.parserPlugins)
      }

      plugins.push({
        visitor: {
          // ğŸ”´  ä¸º define* æ·»åŠ  #__PURE__
          CallExpression(path) {
            if (isDefineCall(path.node)) {
              path.get('callee').addComment('leading', '#__PURE__')
            }
          },
        },
      })

      const result = babel.transformSync(code, {
        sourceFileName: id,
        sourceMaps: true,
        babelrc: false,
        configFile: false,
        plugins,
        parserOpts: {
          plugins: parserPlugins,
        },
      })

      if (result?.code == null) {
        return null
      }

      return {
        code: result.code,
        map: result?.map,
      }
    },
  }
}

export const unplugin = /* #__PURE__ */ createUnplugin(unpluginFactory)

export default unplugin
```

  

è¿™é‡Œä½¿ç”¨ Babel æ¥ parse å’Œ transform ä»£ç ã€‚é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨ï¼Œå¦‚æœåç§°åŒ¹é…åˆ°æˆ‘ä»¬çš„ `define*` åˆ—è¡¨ï¼Œå°±ç»™å®ƒæ·»åŠ  `#__PURE__` æ³¨é‡Šã€‚

å¦‚æœä½ å¯¹ Babel ä»£ç æ„Ÿåˆ°åƒåŠ›ï¼Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç«  æ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜ã€‚

æ”¯æŒ HMR
------

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ­£å¼æ·»åŠ  HMR çš„é€»è¾‘ã€‚

æˆ‘ä»¬éœ€è¦åœ¨ JavaScript æ–‡ä»¶ä¸­æ‰¾å‡ºæ‰€æœ‰ `define*` çš„ â€œå¯¼å‡ºâ€ï¼Œ ä»¥ä¸‹å½¢å¼å¯¼å‡ºæˆ‘ä»¬éƒ½éœ€è¦æ”¯æŒï¼š

```
// å‘½åå¯¼å‡º
export const NamedExport = defineFatForm(/*...*/)
const AnotherNamedExport = defineFatForm(/*...*/)

// å¦ä¸€ç§å‘½åå¯¼å‡º
export { AnotherNamedExport }

// é»˜è®¤å¯¼å‡ºå½¢å¼
export default defineFatForm(/*...*/)
```

è½¬æ¢åçš„ä»£ç ç±»ä¼¼äºï¼š

```
// å‘½åå¯¼å‡º
export const NamedExport = defineFatForm(/*...*/)
const AnotherNamedExport = defineFatForm(/*...*/)

// å¦ä¸€ç§å‘½åå¯¼å‡º
export { AnotherNamedExport }

// ğŸ”´ é»˜è®¤å¯¼å‡ºå½¢å¼, ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡å­˜å‚¨ï¼Œæ–¹ä¾¿åé¢ patch
const __default__ = defineFatForm(/*...*/)
export default __default__

// ğŸ”´ æ³¨å†Œç»„ä»¶å®ä¾‹
if (typeof __VUE_HMR_RUNTIME__ !== 'undefined') {
  NamedExport.__hmrId = 'a1203740'
  AnotherNamedExport.__hmrId = 'bad12ad2'
  __default__.__hmrId = 'x12312w32'

  __VUE_HMR_RUNTIME__.createRecord('a1203740', A)
  __VUE_HMR_RUNTIME__.createRecord('bad12ad2', AnotherNamedExport)
  __VUE_HMR_RUNTIME__.createRecord('x12312w32', __default__)
}

// ğŸ”´ vite HMR
if (import.meta.hot) {
  import.meta.hot.accept(
    ({
      NamedExport: __NamedExport,
      AnotherNamedExport: __AnotherNamedExport,
      default: __default,
    }) => {
      __VUE_HMR_RUNTIME__.reload('a1203740', __NamedExport)
      __VUE_HMR_RUNTIME__.reload('bad12ad2', __AnotherNamedExport)
      __VUE_HMR_RUNTIME__.reload('x12312w32', __default)
    }
  )
}
```

ç…§ç€ä¸Šé¢çš„çº¦å®šï¼Œæˆ‘ä»¬æ¥å®ç°çœ‹çœ‹ï¼š

```
// .. çœç•¥
const DEFAULT_LOCAL_NAME = '__default__'

// ç”Ÿæˆ hash å€¼
function getHash(text: string) {
  return createHash('sha256').update(text).digest('hex').substring(0, 12)
}

// è§£æå‡ºæ¥çš„çƒ­æ›´æ–°ç»„ä»¶
interface HotComponent {
  local: string
  exported: string
  id: string
}

export const unpluginFactory: UnpluginFactory<Options | undefined> = (options, meta) => {
  // ....
  let isWebpack = meta.framework === 'webpack'
  let isVite = meta.framework === 'vite'

  const enableHMR = process.env.NODE_ENV === 'development' && (isWebpack || isVite)
  // ...

  return {
    // ...
    transform(code, id) {
      // ...
      // ğŸ”´ è®°å½•æŸ¥æ‰¾åˆ°çš„ç»„ä»¶
      const hotComponents: HotComponent[] = []

      // ...

      if (enableHMR) {
        // ğŸ”´ æ”¯æŒçƒ­æ›´æ–°
        plugins.push({
          visitor: {
            // ğŸ”´ å¤„ç†å‘½åå¯¼å‡º
            ExportNamedDeclaration(path) {
              if (path.node.declaration && t.isVariableDeclaration(path.node.declaration)) {
                // ğŸ”´ export const xxx = defineXXX() å½¢å¼
                const declarations = path.node.declaration.declarations
                for (const decl of declarations) {
                  if (
                    t.isIdentifier(decl.id) &&
                    decl.init &&
                    t.isCallExpression(decl.init) &&
                    isDefineCall(decl.init)
                  ) {
                    hotComponents.push({
                      local: decl.id.name,
                      exported: decl.id.name,
                      id: getHash(id + decl.id.name),
                    })
                  }
                }
              } else if (path.node.specifiers) {
                // ğŸ”´ export { xxx } å½¢å¼
                const specifiers = path.node.specifiers
                for (const spec of specifiers) {
                  if (t.isExportSpecifier(spec)) {
                    // æŸ¥æ‰¾å˜é‡å®šä¹‰
                    const binding = path.scope.getBinding(spec.local.name)
                    if (
                      binding &&
                      t.isVariableDeclarator(binding.path.node) &&
                      t.isCallExpression(binding.path.node.init) &&
                      isDefineCall(binding.path.node.init)
                    ) {
                      const exported = t.isIdentifier(spec.exported)
                        ? spec.exported.name
                        : spec.exported.value
                      hotComponents.push({
                        local: spec.local.name,
                        exported,
                        id: getHash(id + exported),
                      })
                    }
                  }
                }
              }
            },
            // ğŸ”´ é»˜è®¤å¯¼å‡º
            ExportDefaultDeclaration(path) {
              // export default defineXXX() å½¢å¼
              const declaration = path.node.declaration
              if (t.isCallExpression(declaration) && isDefineCall(declaration)) {
                hotComponents.push({
                  local: DEFAULT_LOCAL_NAME,
                  exported: 'default',
                  id: getHash(id + 'default'),
                })

                // åˆ›å»ºä¸´æ—¶å˜é‡
                const variable = t.variableDeclaration('const', [
                  t.variableDeclarator(t.identifier(DEFAULT_LOCAL_NAME), declaration),
                ])
                const exportDefault = t.exportDefaultDeclaration(t.identifier(DEFAULT_LOCAL_NAME))
                // æ›¿æ¢ export default ä¸º export default __default__
                path.replaceWithMultiple([variable, exportDefault])
              }
            },
          },
        })
      }

      // ....

      if (hotComponents.length !== 0) {
        // ğŸ”´ æ³¨å…¥çƒ­æ›´æ–°ä»£ç 
        const hmrCode = patchHotComponents(hotComponents, meta.framework, id, options?.debug)
        result.code = result.code + hmrCode
      }
      // ...
    },
  }
}

// ...
```

ä¸Šé¢ä»£ç çš„ä¸»è¦é€»è¾‘æ˜¯è¿ç”¨ Babel æ¥éå†å¯¼å‡ºè¯­å¥ï¼Œæ‰¾å‡ºæ‰€æœ‰é€šè¿‡ `define*` åˆ›å»ºçš„ç»„ä»¶ã€‚

æ¥ä¸‹æ¥å°±æ˜¯æ³¨å…¥ HMR çš„ä»£ç ï¼š

```
function patchHotComponents(
  hotComponents: HotComponent[],
  framework: 'vite' | 'webpack',
  id: string,
  debug?: boolean
): string {
  let hmrCode = ''
  let callbackCode = ''
  const debugCode = debug ? `\n  console.log('HMR reloading for ${id}')` : ''

  for (const c of hotComponents) {
    hmrCode +=
      `\n  ${c.local}.__hmrId = ${c.local}.__wkhmr = '${c.id}'` +
      `\n  __VUE_HMR_RUNTIME__.createRecord('${c.id}', ${c.local})`
    callbackCode += `\n  __VUE_HMR_RUNTIME__.reload("${c.id}", __${c.exported})`
  }

  hmrCode = `\nif (typeof __VUE_HMR_RUNTIME__ !== 'undefined') {\n${hmrCode}\n}\n`

  if (framework === 'vite') {
    // ğŸ”´ vite
    hmrCode += `\nif (import.meta.hot) {
  import.meta.hot.accept(({${hotComponents
    .map((c) => `${c.exported}: __${c.exported}`)
    .join(',')}}) => {${debugCode}${callbackCode}\n})
}`
  } else {
    // ğŸ”´ webpack
    hmrCode += `\nif (module.hot) {
  // æ¥å—è‡ªèº«ï¼Œ
  module.hot.accept()
  if (module.hot.status() !== 'idle') {
    const {${hotComponents
      .map((c) => `${c.exported}: __${c.exported}`)
      .join(', ')}} = __webpack_module__.exports
    ${debugCode}
    ${callbackCode}
  }
}`
  }

  return hmrCode
}
```

Vite å’Œ Webpack çš„ HMR API æœ‰ç‚¹å·®å¼‚ã€‚

ç›¸å¯¹è€Œè¨€ Vite ä¼šæ›´ç›´è§‚ä¸€ç‚¹ï¼Œä½¿ç”¨ `import.meta.hot.accept(callback)` ä¸€è¡Œä»£ç å°±å¯ä»¥æå®šï¼Œåªè¦å½“å‰æ¨¡å—å˜åŠ¨ï¼Œå›è°ƒå°±ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¼ å…¥æ–°çš„æ¨¡å—ä¿¡æ¯ã€‚

è€Œ Webpackï¼Œè¦æ¥å—å½“å‰æ¨¡å—çš„æ›´æ–°ï¼Œé¦–å…ˆè¦è°ƒç”¨ä¸€ä¸‹ `module.hot.accept()`ï¼Œè¡¨ç¤ºæœªæ¥çš„æ¨¡å—æ›´æ–°æˆ‘å¯ä»¥è‡ªè¡Œå¤„ç†ã€‚

åé¢æ¯æ¬¡ä»£ç æ¨¡å—æ›´æ–°ï¼Œéƒ½ä¼šé‡æ–°æ‰§è¡Œæ¨¡å—ä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡ `status === 'idle'` æ¥åŒºåˆ†é¦–æ¬¡æ‰§è¡Œï¼Œè¿˜æ˜¯åç»­çš„çƒ­æ›´æ–°é‡æ–°æ‰§è¡Œï¼Œå¦‚æœæ˜¯çƒ­æ›´æ–°æ‰§è¡Œï¼Œå°± reload ç»„ä»¶ã€‚

æ€»ç»“
==

è¿™ç¯‡æ–‡ç« æˆ‘ä»¬èµ°é©¬è§‚èŠ±è®²äº†è®² Webpack å’Œ Rollup çš„æ’ä»¶ APIï¼Œæ¥ç€å¼•å…¥äº† Unpluginã€‚

Unplugin ä»¥ Rollup çš„ç®€ç»ƒæ’ä»¶ API ä¸ºæ¯ç‰ˆï¼Œè¿™å¥— API åŸºæœ¬å°±æ˜¯ä¸»æµæ„å»ºå·¥å…·æ’ä»¶ API çš„æœ€å°å¹¶é›†äº†ï¼Œå¯ä»¥è½»æ¾å…¼å®¹ä¸»æµçš„å¹³å°ã€‚

æ¥ç€ï¼Œå®æˆ˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬åŸºäº Babel å†™äº†ä¸€ä¸ªç®€å•çš„ Vue HMR æ’ä»¶ã€‚

å¦‚æœè¯»è€…æƒ³è¦è¿›ä¸€æ­¥å¦‚ä½•ç¼–å†™æ’ä»¶ï¼Œå¯ä»¥ä¸´æ‘¹ä¸€äº›å®˜æ–¹æ’ä»¶ï¼Œå†æ·±ä¸€ç‚¹ï¼Œå¯ä»¥é¡ºè—¤æ‘¸ç“œçœ‹çœ‹æºç ã€‚

æ‰©å±•é˜…è¯»
====

*   æ·±å…¥æµ…å‡º Babel ä¸Šç¯‡ï¼šæ¶æ„å’ŒåŸç† + å®æˆ˜
    
*   Vite
    
*   https://github.com/unjs/unplugin
    
*   Plugin API | webpack ä¸­æ–‡æ–‡æ¡£
    
*   Rollup
    
*   How Webpack works?
    
*   vite-plugin-vue